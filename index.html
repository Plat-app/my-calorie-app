<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Μετρητής Θερμίδων v6.9</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .app-view { display: none; }
        .app-view.active { display: block; animation: fadeIn 0.3s; }
        #video-container, #modal-video-container {
            position: relative; width: 100%;
            aspect-ratio: 4 / 3; overflow: hidden;
            border-radius: 1.5rem; background-color: #000;
        }
        #video, #modal-video { width: 100%; height: 100%; object-fit: cover; }
        .shutter-button:active { transform: scale(0.95); }
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .calendar-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .calendar-day { aspect-ratio: 1 / 1; }
        .calendar-day.has-entries { background-color: rgba(52, 211, 153, 0.2); border: 1px solid #34d399; }
        .nav-link.active { background-color: #4a5568; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Header with Menu -->
    <header class="bg-gray-800 p-4 flex items-center justify-between sticky top-0 z-40">
        <h1 id="header-title" class="text-xl font-bold text-cyan-400">Σάρωση Φαγητού</h1>
        <button id="menu-btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
    </header>

    <!-- Side Menu -->
    <div id="side-menu" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <nav class="bg-gray-800 w-64 h-full p-4 space-y-2">
            <a href="#" class="nav-link block p-2 rounded" data-view="scanner-view">Σάρωση Φαγητού</a>
            <a href="#" class="nav-link block p-2 rounded" data-view="calendar-view">Το Ημερολόγιό μου</a>
            <a href="#" class="nav-link block p-2 rounded" data-view="library-view">Η Βιβλιοθήκη μου</a>
        </nav>
    </div>

    <main class="p-4">
        <!-- Scanner View -->
        <div id="scanner-view" class="app-view active max-w-md mx-auto">
             <div class="bg-gray-800 rounded-3xl shadow-2xl p-6 mb-4">
                <div id="video-container" class="mb-2 shadow-lg">
                    <div id="camera-activator" class="absolute inset-0 bg-gray-700 flex flex-col items-center justify-center rounded-2xl z-10 cursor-pointer hover:bg-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <p class="text-white font-semibold">Ενεργοποίηση Κάμερας</p>
                    </div>
                    <video id="video" class="hidden" playsinline autoplay muted></video>
                </div>
                <p id="scan-instruction" class="text-center text-xs text-amber-400 mb-4 bg-gray-700/50 p-2 rounded-lg">Ενεργοποιήστε την κάμερα για να ξεκινήσετε.</p>
                <canvas id="canvas" class="hidden"></canvas>
                <div class="flex justify-center mb-6"><button id="capture-btn" class="shutter-button transition-all w-20 h-20 bg-white rounded-full border-4 border-gray-500 flex items-center justify-center focus:outline-none" disabled><div class="w-16 h-16 bg-white rounded-full border-2 border-gray-900"></div></button></div>
                <div id="result-container" class="bg-gray-700/50 p-4 rounded-xl min-h-[120px] flex items-center justify-center text-center">
                    <div id="loading" class="hidden flex-col items-center"><div class="spinner w-8 h-8 rounded-full border-4 border-gray-500 mb-2"></div><p id="loading-text" class="text-gray-400">Ανάλυση...</p></div>
                    <div id="result-text"><p class="text-gray-400">Τα αποτελέσματα θα εμφανιστούν εδώ.</p></div>
                    <div id="error-message" class="hidden text-red-400"></div>
                </div>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendar-view" class="app-view max-w-md mx-auto">
            <div class="flex justify-between items-center mb-4"><button id="prev-month-btn" class="p-2 rounded-full bg-gray-700">&lt;</button><h2 id="month-year-title" class="text-xl font-semibold"></h2><button id="next-month-btn" class="p-2 rounded-full bg-gray-700">&gt;</button></div>
            <div class="grid calendar-grid text-center font-semibold text-xs text-gray-400 mb-2"><div>ΔΕΥ</div><div>ΤΡΙ</div><div>ΤΕΤ</div><div>ΠΕΜ</div><div>ΠΑΡ</div><div>ΣΑΒ</div><div>ΚΥΡ</div></div>
            <div id="calendar-body" class="grid calendar-grid gap-1"></div>
        </div>
        
        <!-- Daily Log View -->
        <div id="daily-log-view" class="app-view max-w-md mx-auto">
             <button class="back-to-calendar-btn text-cyan-400 mb-4">&lt; Επιστροφή στο Ημερολόγιο</button>
             <h2 id="daily-log-date" class="text-2xl font-bold mb-4"></h2>
             <ul id="daily-log-list" class="space-y-2 mb-4"></ul>
             <div class="bg-gray-700 p-4 rounded-lg text-right"><p class="text-gray-400">Σύνολο Ημέρας:</p><p id="daily-log-total" class="text-2xl font-bold text-cyan-400"></p></div>
        </div>
        
        <!-- Library View -->
        <div id="library-view" class="app-view max-w-md mx-auto">
             <button id="add-product-from-library-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg mb-4">+ Προσθήκη Νέου Προϊόντος</button>
            <ul id="product-library-list" class="space-y-3"></ul>
        </div>
    </main>

    <!-- Modals -->
    <div id="add-product-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl w-full max-w-md p-6 flex flex-col">
            <div id="modal-video-container" class="mb-4"><video id="modal-video" class="rounded-lg" playsinline autoplay muted></video></div>
            <div id="modal-steps-container">
                <div id="modal-step-1" class="modal-step"><h2 class="text-xl font-bold mb-2">Βήμα 1: Σάρωση Ετικέτας</h2><p class="text-sm text-gray-400 mb-4">Για καλύτερη εστίαση, πατήστε στην οθόνη πριν τη λήψη.</p><button id="capture-label-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Σάρωση Ετικέtas</button><button class="modal-cancel-btn w-full mt-2 text-gray-400">Άκυρο</button></div>
                <div id="modal-step-2" class="hidden modal-step"><h2 id="step2-title" class="text-xl font-bold mb-2">Βήμα 2: Επιβεβαίωση Θερμίδων και Βάρους</h2><div class="mb-4"><label for="calories-input" class="block text-sm font-medium text-gray-300">Θερμίδες ανά 100g (kcal)</label><input type="number" id="calories-input" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white"></div><div class="mb-4"><label for="weight-input" class="block text-sm font-medium text-gray-300">Βάρος προϊόντος (g)</label><input type="number" id="weight-input" placeholder="π.χ. 60" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white"></div><button id="confirm-data-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Επόμενο Βήμα</button><button class="modal-cancel-btn w-full mt-2 text-gray-400">Άκυρο</button></div>
                <div id="modal-step-3" class="hidden modal-step"><h2 class="text-xl font-bold mb-2">Βήμα 3: Φωτογράφιση Προϊόντος</h2><p class="text-sm text-gray-400 mb-4">Τώρα, φωτογραφίστε το ίδιο το προϊόν, καθαρά και μόνο του.</p><button id="capture-product-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Φωτογράφιση Προϊόντος</button><button class="modal-cancel-btn w-full mt-2 text-gray-400">Άκυρο</button></div>
                <div id="modal-step-4" class="hidden modal-step"><h2 id="step4-title" class="text-xl font-bold mb-2">Βήμα 4: Ονομασία</h2><div class="mb-4"><img id="product-preview-img" src="" class="rounded-lg max-h-32 mx-auto mb-2"><button id="recapture-product-btn" class="hidden text-sm text-blue-400 hover:text-blue-300 mb-2">Νέα Φωτογραφία</button><label for="product-name-input" class="block text-sm font-medium text-gray-300">Δώστε ένα όνομα στο προϊόν σας</label><input type="text" id="product-name-input" placeholder="π.χ. Η μπάρα μου" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white"></div><button id="save-product-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">Αποθήκευση</button><button class="modal-cancel-btn w-full mt-2 text-gray-400">Άκυρο</button></div>
            </div>
        </div>
    </div>
    <div id="custom-dialog" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"><div class="bg-gray-700 rounded-lg p-6 max-w-sm w-full text-center"><p id="dialog-message" class="text-white mb-6"></p><div id="dialog-buttons" class="flex justify-center space-x-4"><button id="dialog-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg">OK</button><button id="dialog-cancel-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-lg">Άκυρο</button></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const headerTitle = document.getElementById('header-title');
            const menuBtn = document.getElementById('menu-btn');
            const sideMenu = document.getElementById('side-menu');
            const navLinks = document.querySelectorAll('.nav-link');
            const appViews = document.querySelectorAll('.app-view');
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const captureBtn = document.getElementById('capture-btn');
            const resultText = document.getElementById('result-text');
            const loadingIndicator = document.getElementById('loading');
            const loadingText = document.getElementById('loading-text');
            const errorMessage = document.getElementById('error-message');
            const cameraActivator = document.getElementById('camera-activator');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const monthYearTitle = document.getElementById('month-year-title');
            const calendarBody = document.getElementById('calendar-body');
            const dailyLogDateEl = document.getElementById('daily-log-date');
            const dailyLogListEl = document.getElementById('daily-log-list');
            const dailyLogTotalEl = document.getElementById('daily-log-total');
            const addProductFromLibraryBtn = document.getElementById('add-product-from-library-btn');
            const productLibraryList = document.getElementById('product-library-list');
            const modal = document.getElementById('add-product-modal');
            const customDialog = document.getElementById('custom-dialog');
            const dialogMessage = document.getElementById('dialog-message');
            const dialogOkBtn = document.getElementById('dialog-ok-btn');
            const dialogCancelBtn = document.getElementById('dialog-cancel-btn');

            let mealData = {};
            let productLibrary = [];
            let currentDate = new Date();
            let mainStream, modalStream;
            let editMode = false;
            let editProductId = null;
            let newProductData = {};

            function switchView(viewId) {
                appViews.forEach(view => view.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                const newView = document.getElementById(viewId);
                if(newView) newView.classList.add('active');
                const link = document.querySelector(`.nav-link[data-view="${viewId}"]`);
                if(link) { headerTitle.textContent = link.textContent; link.classList.add('active'); }
                sideMenu.classList.add('hidden');
            }

            menuBtn.addEventListener('click', () => sideMenu.classList.toggle('hidden'));
            sideMenu.addEventListener('click', (e) => { if (e.target === sideMenu) sideMenu.classList.add('hidden'); });
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const viewId = e.target.dataset.view;
                    switchView(viewId);
                    if(viewId === 'calendar-view') renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
                    if(viewId === 'library-view') renderProductLibrary();
                });
            });

            function saveData() { localStorage.setItem('mealData', JSON.stringify(mealData)); localStorage.setItem('productLibrary', JSON.stringify(productLibrary)); }
            function loadData() { mealData = JSON.parse(localStorage.getItem('mealData') || '{}'); productLibrary = JSON.parse(localStorage.getItem('productLibrary') || '[]'); }

            function renderCalendar(year, month) {
                currentDate = new Date(year, month, 1);
                calendarBody.innerHTML = '';
                monthYearTitle.textContent = `${currentDate.toLocaleString('el-GR', { month: 'long' })} ${year}`;
                const firstDayOfMonth = (new Date(year, month, 1).getDay() + 6) % 7;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDayOfMonth; i++) calendarBody.innerHTML += `<div class="calendar-day"></div>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayMeals = mealData[dateStr] || [];
                    const totalCalories = dayMeals.reduce((sum, meal) => sum + meal.calories, 0);
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day flex flex-col items-center justify-center p-1 border border-gray-700 rounded-md cursor-pointer hover:bg-gray-700';
                    if(dayMeals.length > 0) dayDiv.classList.add('has-entries');
                    dayDiv.innerHTML = `<span class="font-bold">${day}</span>`;
                    if(totalCalories > 0) dayDiv.innerHTML += `<span class="text-xs text-cyan-400">${totalCalories} kcal</span>`;
                    dayDiv.addEventListener('click', () => { renderDailyLog(dateStr); switchView('daily-log-view'); });
                    calendarBody.appendChild(dayDiv);
                }
            }
            prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
            nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
            
            function renderDailyLog(dateStr) {
                const date = new Date(dateStr.replace(/-/g, '/'));
                dailyLogDateEl.textContent = date.toLocaleDateString('el-GR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                headerTitle.textContent = 'Ημερήσιο Log';
                const dayMeals = mealData[dateStr] || [];
                dailyLogListEl.innerHTML = '';
                if (dayMeals.length === 0) { dailyLogListEl.innerHTML = `<li class="text-gray-500 text-center">Δεν υπάρχουν γεύματα.</li>`; }
                else {
                    dayMeals.sort((a,b) => a.time.localeCompare(b.time));
                    dayMeals.forEach(meal => {
                        const li = document.createElement('li');
                        li.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                        li.innerHTML = `<div><p class="font-semibold">${meal.name}</p><p class="text-sm text-gray-400">${meal.time}</p></div><strong class="text-cyan-400">${meal.calories} kcal</strong>`;
                        dailyLogListEl.appendChild(li);
                    });
                }
                dailyLogTotalEl.textContent = `${dayMeals.reduce((sum, meal) => sum + meal.calories, 0)} kcal`;
            }
            document.body.addEventListener('click', e => { if (e.target.matches('.back-to-calendar-btn')) switchView('calendar-view'); });

            async function startCamera(videoElement, activatorElement = null, forLabel = false) {
                try {
                    if(videoElement.srcObject) videoElement.srcObject.getTracks().forEach(track => track.stop());
                    const constraints = { video: { facingMode: 'environment' } };
                    if (forLabel) {
                        const capabilities = navigator.mediaDevices.getSupportedConstraints();
                        if (capabilities.focusMode) {
                            constraints.video.advanced = [{ focusMode: "continuous" }];
                        }
                    }
                    const stream = await navigator.mediaDevices.getUserMedia(constraints);
                    videoElement.srcObject = stream;
                    if (activatorElement) activatorElement.classList.add('hidden');
                    videoElement.classList.remove('hidden');
                    if (videoElement.id === 'video') { captureBtn.disabled = false; document.getElementById('scan-instruction').textContent = 'Σαρώστε ένα φαγητό...'; }
                    return stream;
                } catch (err) {
                    const message = "Η πρόσβαση στην κάμερα απέτυχε. Ελέγξτε τις άδειες του browser και ανανεώστε τη σελίδα.";
                    if (activatorElement) {
                         activatorElement.innerHTML = `<div class="p-4 text-center"><p class="text-red-400">${message}</p><button id="retry-camera-btn" class="mt-4 bg-blue-600 px-4 py-2 rounded-lg">Δοκιμάστε ξανά</button></div>`;
                         document.getElementById('retry-camera-btn').addEventListener('click', () => {
                             cameraActivator.innerHTML = `<div class="spinner w-8 h-8 rounded-full border-4 border-gray-500"></div>`;
                             startCamera(video, cameraActivator);
                         });
                    } else {
                        await showCustomAlert(message);
                    }
                    return null;
                }
            }
            function stopCamera(stream) { if (stream) stream.getTracks().forEach(track => track.stop()); }
            cameraActivator.addEventListener('click', () => { cameraActivator.innerHTML = `<div class="spinner w-8 h-8 rounded-full border-4 border-gray-500"></div>`; mainStream = startCamera(video, cameraActivator); });

            captureBtn.addEventListener('click', async () => {
                showLoading('Έξυπνη ανάλυση...');
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth; canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                const base64ImageData = canvas.toDataURL('image/png').split(',')[1];
                const productNames = productLibrary.map(p => `"${p.name}"`);
                const prompt = `Analyze the main food item in this image. Here is a list of my personal saved products: [${productNames.join(', ')}]. First, does the item in the image visually match any of the products in that list? If YES, respond with ONLY a valid JSON object like this: {"match_type": "personal", "product_name": "The name from the list that matched"}. If NO, it's a generic food. Look for a 1 Euro coin and respond with ONLY a valid JSON object like this: {"match_type": "generic", "food_name_greek": "Name", "calories_per_100g": 123, "estimated_weight_g": 123}. If you cannot identify food, respond with {"match_type": "none"}.`;
                try {
                    const aiResponse = await callAI(prompt, base64ImageData);
                    if (aiResponse.match_type === 'personal') {
                        const matchedProduct = productLibrary.find(p => p.name === aiResponse.product_name);
                        if (!matchedProduct) throw new Error(`AI hallucinated a product name: ${aiResponse.product_name}`);
                        const finalCalories = Math.round((matchedProduct.weight / 100) * matchedProduct.caloriesPer100g);
                        addEntryToHistory({ name: matchedProduct.name, weight: matchedProduct.weight, calories: finalCalories });
                        displayScanResult(`<p class="text-purple-400 text-sm">Από τη Βιβλιοθήκη:</p><p class="text-xl font-semibold">${matchedProduct.name}</p><p class="text-3xl font-bold text-cyan-400 mt-1">${finalCalories} kcal</p>`);
                    } else if (aiResponse.match_type === 'generic') {
                        const { food_name_greek, calories_per_100g, estimated_weight_g } = aiResponse;
                        if (!food_name_greek || !calories_per_100g || !estimated_weight_g) throw new Error("AI failed to provide all generic food details.");
                        const finalCalories = Math.round((estimated_weight_g / 100) * calories_per_100g);
                        addEntryToHistory({ name: food_name_greek, weight: Math.round(estimated_weight_g), calories: finalCalories });
                        displayScanResult(`<p class="text-xl font-semibold">${food_name_greek}</p><p class="text-sm text-gray-400">Εκτίμ. Βάρος (AI): <span class="font-bold text-white">${Math.round(estimated_weight_g)}g</span></p><p class="text-3xl font-bold text-cyan-400 mt-1">${finalCalories} kcal</p>`);
                    } else { throw new Error("Could not identify food or match type."); }
                } catch (e) { showError('Απέτυχε η ανάλυση. Δοκιμάστε ξανά.'); console.error(e); } finally { hideLoading(); }
            });

            function addEntryToHistory(entry) {
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                const newMeal = { ...entry, time: timeStr };
                if (!mealData[dateStr]) mealData[dateStr] = [];
                mealData[dateStr].push(newMeal);
                saveData();
                showCustomAlert(`"${entry.name}" προστέθηκε στη σημερινή καταγραφή!`);
            }
            function displayScanResult(htmlContent) { resultText.classList.remove('hidden'); loadingIndicator.classList.add('hidden'); resultText.innerHTML = htmlContent; }

            function showLoading(text) { loadingText.textContent = text; resultText.classList.add('hidden'); errorMessage.classList.add('hidden'); loadingIndicator.classList.remove('hidden'); }
            function hideLoading() { loadingIndicator.classList.add('hidden'); }
            function showError(message) { errorMessage.textContent = message; errorMessage.classList.remove('hidden'); hideLoading(); }
            function showCustomAlert(message, isConfirm = false) { return new Promise(resolve => { customDialog.classList.remove('hidden'); customDialog.classList.add('flex'); dialogMessage.textContent = message; dialogOkBtn.onclick = () => { customDialog.classList.add('hidden'); customDialog.classList.remove('flex'); resolve(true); }; dialogCancelBtn.onclick = () => { customDialog.classList.add('hidden'); customDialog.classList.remove('flex'); resolve(false); }; dialogCancelBtn.style.display = isConfirm ? 'inline-block' : 'none'; }); }
            
            addProductFromLibraryBtn.addEventListener('click', () => openAddModal(false));
            
            function renderProductLibrary() {
                productLibraryList.innerHTML = '';
                if (productLibrary.length === 0) { productLibraryList.innerHTML = `<li class="text-gray-500 text-center">Η βιβλιοθήκη σας είναι άδεια.</li>`; return; }
                productLibrary.forEach(product => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                    li.innerHTML = `<div class="flex items-center space-x-3"><img src="${product.imageBase64}" class="w-12 h-12 rounded-md object-cover"><div><p class="font-semibold">${product.name}</p><p class="text-sm text-gray-400">${product.caloriesPer100g} kcal/100g - ${product.weight}g</p></div></div><div class="flex space-x-2"><button class="edit-product-btn text-sm bg-blue-600 p-2 rounded" data-id="${product.id}">Επεξεργασία</button><button class="delete-product-btn text-sm bg-red-600 p-2 rounded" data-id="${product.id}">Διαγραφή</button></div>`;
                    productLibraryList.appendChild(li);
                });
                document.querySelectorAll('.edit-product-btn').forEach(btn => btn.addEventListener('click', handleEditProduct));
                document.querySelectorAll('.delete-product-btn').forEach(btn => btn.addEventListener('click', handleDeleteProduct));
            }
            async function handleEditProduct(event) { const product = productLibrary.find(p => p.id === event.target.dataset.id); if (product) openAddModal(true, product); }
            async function handleDeleteProduct(event) { const productId = event.target.dataset.id; const confirmed = await showCustomAlert('Είστε σίγουροι για τη διαγραφή;', true); if (confirmed) { productLibrary = productLibrary.filter(p => p.id !== productId); saveData(); renderProductLibrary(); } }
            
            function showModalStep(step) {
                const stepsContainer = modal.querySelector('#modal-steps-container');
                stepsContainer.querySelectorAll('.modal-step').forEach(s => s.classList.add('hidden'));
                const currentStep = stepsContainer.querySelector(`#modal-step-${step}`);
                if (currentStep) currentStep.classList.remove('hidden');
                modal.querySelector('#modal-video-container').style.display = (step === 1 || step === 3) ? 'block' : 'none';
            }

            function openAddModal(isEditing = false, product = null) {
                editMode = isEditing;
                const m = modal;
                if (isEditing && product) {
                    editProductId = product.id;
                    m.querySelector('#calories-input').value = product.caloriesPer100g;
                    m.querySelector('#weight-input').value = product.weight;
                    m.querySelector('#product-name-input').value = product.name;
                    m.querySelector('#product-preview-img').src = product.imageBase64;
                    newProductData = { imageBase64: product.imageBase64 };
                    m.querySelector('#step2-title').textContent = 'Επεξεργασία Δεδομένων';
                    m.querySelector('#step4-title').textContent = 'Επεξεργασία Ονόματος';
                    m.querySelector('#save-product-btn').textContent = 'Αποθήκευση Αλλαγών';
                    m.querySelector('#recapture-product-btn').classList.remove('hidden');
                } else {
                    editProductId = null;
                    ['#calories-input', '#weight-input', '#product-name-input'].forEach(sel => m.querySelector(sel).value = '');
                    m.querySelector('#product-preview-img').src = '';
                    newProductData = {};
                    m.querySelector('#step2-title').textContent = 'Βήμα 2: Επιβεβαίωση Θερμίδων και Βάρους';
                    m.querySelector('#step4-title').textContent = 'Βήμα 4: Ονομασία';
                    m.querySelector('#save-product-btn').textContent = 'Αποθήκευση Προϊόντος';
                    m.querySelector('#recapture-product-btn').classList.add('hidden');
                }
                m.classList.remove('hidden'); m.classList.add('flex');
                startCamera(m.querySelector('#modal-video'), null, true).then(stream => modalStream = stream);
                showModalStep(isEditing ? 2 : 1);
            }

            function closeModal() { modal.classList.add('hidden'); stopCamera(modalStream); }

            async function onCaptureLabel() {
                const btn = modal.querySelector('#capture-label-btn');
                btn.textContent = "Ανάλυση..."; btn.disabled = true;
                const context = canvas.getContext('2d');
                const mVideo = modal.querySelector('#modal-video');
                canvas.width = mVideo.videoWidth; canvas.height = mVideo.videoHeight;
                context.drawImage(mVideo, 0, 0, canvas.width, canvas.height);
                const base64ImageData = canvas.toDataURL('image/png').split(',')[1];
                const prompt = `From the image of this nutrition label, extract the number of calories (kcal) per 100g. Please respond with ONLY a valid JSON object like this: {"calories": 123}`;
                try {
                    const aiResponse = await callAI(prompt, base64ImageData);
                    const calories = parseInt(aiResponse.calories, 10);
                    if (isNaN(calories)) throw new Error("Could not parse calories from AI response.");
                    modal.querySelector('#calories-input').value = calories;
                    showModalStep(2);
                } catch (e) { await showCustomAlert("Δεν ήταν δυνατή η ανάγνωση. Εισάγετε χειροκίνητα."); showModalStep(2); } 
                finally { btn.textContent = "Σάρωση Ετικέτας"; btn.disabled = false; }
            }
            async function onConfirmData() {
                const calories = parseInt(modal.querySelector('#calories-input').value, 10);
                const weight = parseInt(modal.querySelector('#weight-input').value, 10);
                if(isNaN(calories) || isNaN(weight) || calories <= 0 || weight <= 0) { await showCustomAlert("Εισάγετε έγκυρες τιμές."); return; }
                newProductData.caloriesPer100g = calories; newProductData.weight = weight;
                showModalStep(3);
            }
            async function onCaptureProduct() {
                const context = canvas.getContext('2d');
                const mVideo = modal.querySelector('#modal-video');
                canvas.width = mVideo.videoWidth; canvas.height = mVideo.videoHeight;
                context.drawImage(mVideo, 0, 0, canvas.width, canvas.height);
                newProductData.imageBase64 = canvas.toDataURL('image/png');
                modal.querySelector('#product-preview-img').src = newProductData.imageBase64;
                showModalStep(4);
            }
            async function onSaveProduct() {
                const name = modal.querySelector('#product-name-input').value.trim();
                const calories = parseInt(modal.querySelector('#calories-input').value, 10);
                const weight = parseInt(modal.querySelector('#weight-input').value, 10);
                if (!name || isNaN(calories) || isNaN(weight)) { await showCustomAlert("Συμπληρώστε όλα τα πεδία."); return; }
                if (editMode && editProductId) {
                    const idx = productLibrary.findIndex(p => p.id === editProductId);
                    if (idx !== -1) { productLibrary[idx] = {...productLibrary[idx], name, caloriesPer100g: calories, weight, imageBase64: newProductData.imageBase64 || productLibrary[idx].imageBase64 }; }
                    await showCustomAlert('Οι αλλαγές αποθηκεύτηκαν!');
                } else {
                    productLibrary.push({ id: `prod_${Date.now()}`, name, caloriesPer100g: calories, weight, imageBase64: newProductData.imageBase64 });
                    await showCustomAlert(`Το προϊόν "${name}" αποθηκεύτηκε!`);
                }
                saveData();
                closeModal();
                switchView('library-view');
                renderProductLibrary();
            }

            async function callAI(prompt, base64ImageData, expectJson = true) {
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }, { inlineData: { mimeType: "image/png", data: base64ImageData } }]}]};
                if(expectJson) payload.generationConfig = { responseMimeType: "application/json" };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!aiResponseText) throw new Error("No response from AI.");
                return expectJson ? JSON.parse(aiResponseText) : aiResponseText;
            }
            
            document.body.addEventListener('click', e => {
                if (e.target.matches('.modal-cancel-btn')) closeModal();
                if (e.target.matches('#add-product-from-library-btn')) openAddModal(false);
                if (e.target.matches('#capture-label-btn')) onCaptureLabel();
                if (e.target.matches('#confirm-data-btn')) onConfirmData();
                if (e.target.matches('#capture-product-btn')) onCaptureProduct();
                if (e.target.matches('#save-product-btn')) onSaveProduct();
                if (e.target.matches('#recapture-product-btn')) showModalStep(3);
            });
            
            loadData();
            switchView('scanner-view');
        });
    </script>
</body>
</html>
