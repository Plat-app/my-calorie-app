<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Μετρητής Θερμίδων v13.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .app-view { display: none; }
        .app-view.active { display: block; animation: fadeIn 0.3s; }
        #video-container, #modal-video-container {
            position: relative; width: 100%;
            aspect-ratio: 4 / 3; overflow: hidden;
            border-radius: 1.5rem; background-color: #000;
        }
        #video, #modal-video { width: 100%; height: 100%; object-fit: cover; }
        .shutter-button:active { transform: scale(0.95); }
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .calendar-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .calendar-day { aspect-ratio: 1 / 1; }
        .calendar-day.has-entries { background-color: rgba(52, 211, 153, 0.2); border: 1px solid #34d399; }
        .nav-link.active { background-color: #4a5568; }
        .fab {
            position: fixed;
            bottom: 6rem; /* Increased bottom margin significantly */
            z-index: 30;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <!-- Header with Menu -->
    <header class="bg-gray-800 p-4 flex items-center justify-between sticky top-0 z-40">
        <h1 id="header-title" class="text-xl font-bold text-cyan-400">Σήμερα</h1>
        <button id="menu-btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
    </header>

    <!-- Side Menu -->
    <div id="side-menu" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <nav class="bg-gray-800 w-64 h-full p-4 space-y-2">
            <a href="#" class="nav-link block p-2 rounded" data-view="today-view">Σήμερα</a>
            <a href="#" class="nav-link block p-2 rounded" data-view="calendar-view">Το Ημερολόγιό μου</a>
            <a href="#" class="nav-link block p-2 rounded" data-view="library-view">Η Βιβλιοθήκη μου</a>
        </nav>
    </div>

    <main class="p-4">
        <!-- Today View (New Default) -->
        <div id="today-view" class="app-view active max-w-md mx-auto">
            <div class="bg-gray-800 rounded-3xl shadow-2xl p-6 mb-4">
                <h2 class="text-lg font-semibold text-gray-300 mb-4">Επισκόπηση 7 Ημερών</h2>
                <div id="weekly-chart" class="h-40 flex justify-between items-end space-x-2"></div>
            </div>
            <div class="bg-gray-800 rounded-3xl shadow-2xl p-6 mb-4">
                <p class="text-gray-400">Σύνολο Σήμερα</p>
                <p id="today-total-calories" class="text-5xl font-bold text-cyan-400">0 kcal</p>
            </div>
            <h2 class="text-lg font-semibold mb-2">Γεύματα Ημέρας</h2>
            <ul id="today-log-list" class="space-y-2 pb-24"></ul>
        </div>
        
        <!-- Scanner View -->
        <div id="scanner-view" class="app-view max-w-md mx-auto">
            <button class="back-to-today-btn text-cyan-400 mb-4">&lt; Επιστροφή στο Σήμερα</button>
             <div class="bg-gray-800 rounded-3xl shadow-2xl p-6 mb-4">
                <div id="video-container" class="mb-2 shadow-lg">
                    <div id="camera-activator" class="absolute inset-0 bg-gray-700 flex flex-col items-center justify-center rounded-2xl z-10 cursor-pointer hover:bg-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <p class="text-white font-semibold">Ενεργοποίηση Κάμερας</p>
                    </div>
                    <video id="video" class="hidden" playsinline autoplay muted></video>
                </div>
                <p id="scan-instruction" class="text-center text-xs text-amber-400 mb-4 bg-gray-700/50 p-2 rounded-lg">Ενεργοποιήστε την κάμερα για να ξεκινήσετε.</p>
                <canvas id="canvas" class="hidden"></canvas>
                <div class="flex justify-center mb-6"><button id="capture-btn" class="shutter-button transition-all w-20 h-20 bg-white rounded-full border-4 border-gray-500 flex items-center justify-center focus:outline-none" disabled><div class="w-16 h-16 bg-white rounded-full border-2 border-gray-900"></div></button></div>
            </div>
        </div>

        <!-- Confirmation View -->
        <div id="confirmation-view" class="app-view max-w-md mx-auto">
            <h2 class="text-2xl font-bold mb-4">Επιβεβαίωση & Λεπτομέρειες</h2>
            <img id="confirmation-image" src="" class="rounded-lg w-full mb-4">
            <div class="mb-4">
                <label for="details-input" class="block text-sm font-medium text-gray-300 mb-1">Προσθέστε λεπτομέρειες (προαιρετικό)</label>
                <textarea id="details-input" placeholder="π.χ. με 2 φέτες τυρί, χωρίς σως" class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-white" rows="3"></textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button id="retake-photo-btn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg">Νέα Λήψη</button>
                <button id="analyze-final-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg">Ανάλυση Γεύματος</button>
            </div>
        </div>

        <!-- Calendar View -->
        <div id="calendar-view" class="app-view max-w-md mx-auto">
            <div class="flex justify-between items-center mb-4"><button id="prev-month-btn" class="p-2 rounded-full bg-gray-700">&lt;</button><h2 id="month-year-title" class="text-xl font-semibold"></h2><button id="next-month-btn" class="p-2 rounded-full bg-gray-700">&gt;</button></div>
            <div class="grid calendar-grid text-center font-semibold text-xs text-gray-400 mb-2"><div>ΔΕΥ</div><div>ΤΡΙ</div><div>ΤΕΤ</div><div>ΠΕΜ</div><div>ΠΑΡ</div><div>ΣΑΒ</div><div>ΚΥΡ</div></div>
            <div id="calendar-body" class="grid calendar-grid gap-1"></div>
        </div>
        
        <!-- Daily Log View -->
        <div id="daily-log-view" class="app-view max-w-md mx-auto">
             <button class="back-to-calendar-btn text-cyan-400 mb-4">&lt; Επιστροφή στο Ημερολόγιο</button>
             <h2 id="daily-log-date" class="text-2xl font-bold mb-4"></h2>
             <ul id="daily-log-list" class="space-y-2 mb-4"></ul>
             <div class="bg-gray-700 p-4 rounded-lg text-right"><p class="text-gray-400">Σύνολο Ημέρας:</p><p id="daily-log-total" class="text-2xl font-bold text-cyan-400"></p></div>
        </div>
        
        <!-- Library View -->
        <div id="library-view" class="app-view max-w-md mx-auto">
             <button id="add-product-from-library-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg mb-4">+ Προσθήκη Νέου Προϊόντος</button>
            <ul id="product-library-list" class="space-y-3 pb-24"></ul>
        </div>
    </main>

    <!-- Floating Action Buttons -->
    <button id="text-analyzer-fab" class="fab left-6 w-14 h-14 bg-green-600 rounded-full flex items-center justify-center text-white shadow-lg hover:bg-green-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
    </button>
    <button id="fab-scan-btn" class="fab right-6 w-16 h-16 bg-indigo-600 rounded-full flex items-center justify-center text-white shadow-lg hover:bg-indigo-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
    </button>

    <!-- Modals -->
    <div id="add-product-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl w-full max-w-md p-6 flex flex-col">
            <div id="modal-video-container" class="mb-4"><video id="modal-video" class="rounded-lg" playsinline autoplay muted></video></div>
            <div id="modal-steps-container">
                <div id="modal-step-1" class="modal-step"><h2 class="text-xl font-bold mb-2">Βήμα 1: Σάρωση Ετικέτας</h2><p class="text-sm text-gray-400 mb-4">Για καλύτερη εστίαση, πατήστε στην οθόνη πριν τη λήψη.</p><button id="capture-label-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Σάρωση Ετικέtas</button><button class="modal-cancel-btn w-full mt-2 text-gray-400">Άκυρο</button></div>
                <div id="modal-step-2" class="hidden modal-step"><h2 id="step2-title" class="text-xl font-bold mb-2">Βήμα 2: Επιβεβαίωση Θερμίδων και Βάρους</h2><div class="mb-4"><label for="calories-input" class="block text-sm font-medium text-gray-300">Θερμίδες ανά 100g (kcal)</label><input type="number" id="calories-input" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white"></div><div class="mb-4"><label for="weight-input" class="block text-sm font-medium text-gray-300">Βάρος προϊόντος (g)</label><input type="number" id="weight-input" placeholder="π.χ. 60" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white"></div><button id="confirm-data-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Επόμενο Βήμα</button><button class="modal-cancel-btn w-full mt-2 text-gray-400">Άκυρο</button></div>
                <div id="modal-step-3" class="hidden modal-step"><h2 class="text-xl font-bold mb-2">Βήμα 3: Φωτογράφιση Προϊόντος</h2><p class="text-sm text-gray-400 mb-4">Τώρα, φωτογραφίστε το ίδιο το προϊόν, καθαρά και μόνο του.</p><button id="capture-product-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Φωτογράφιση Προϊόντος</button><button class="modal-cancel-btn w-full mt-2 text-gray-400">Άκυρο</button></div>
                <div id="modal-step-4" class="hidden modal-step"><h2 id="step4-title" class="text-xl font-bold mb-2">Βήμα 4: Ονομασία</h2><div class="mb-4"><img id="product-preview-img" src="" class="rounded-lg max-h-32 mx-auto mb-2"><button id="recapture-product-btn" class="hidden text-sm text-blue-400 hover:text-blue-300 mb-2">Νέα Φωτογραφία</button><label for="product-name-input" class="block text-sm font-medium text-gray-300">Δώστε ένα όνομα στο προϊόν σας</label><input type="text" id="product-name-input" placeholder="π.χ. Η μπάρα μου" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white"></div><button id="save-product-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">Αποθήκευση</button><button class="modal-cancel-btn w-full mt-2 text-gray-400">Άκυρο</button></div>
            </div>
        </div>
    </div>
    <div id="text-analyzer-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl w-full max-w-md p-6 flex flex-col">
            <h2 class="text-xl font-bold mb-2">✨ Αναλυτής Γεύματος</h2>
            <p class="text-sm text-gray-400 mb-4">Περιγράψτε το γεύμα σας (π.χ. "Σαλάτα με κοτόπουλο και σως").</p>
            <textarea id="text-analyzer-input" class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-white" rows="4"></textarea>
            <button id="analyze-text-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg mt-4">Ανάλυση & Προσθήκη</button>
            <button class="text-analyzer-cancel-btn w-full mt-2 text-gray-400">Άκυρο</button>
        </div>
    </div>
    <div id="custom-dialog" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"><div class="bg-gray-700 rounded-lg p-6 max-w-sm w-full text-center"><p id="dialog-message" class="text-white mb-6"></p><div id="dialog-buttons" class="flex justify-center space-x-4"><button id="dialog-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg">OK</button><button id="dialog-cancel-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-lg">Άκυρο</button></div></div></div>
    <div id="toast-notification" class="hidden fixed bottom-24 left-1/2 -translate-x-1/2 bg-gray-700 text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transform translate-y-4"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const allElements = {
                headerTitle: document.getElementById('header-title'),
                menuBtn: document.getElementById('menu-btn'),
                sideMenu: document.getElementById('side-menu'),
                navLinks: document.querySelectorAll('.nav-link'),
                appViews: document.querySelectorAll('.app-view'),
                fabScanBtn: document.getElementById('fab-scan-btn'),
                todayTotalCaloriesEl: document.getElementById('today-total-calories'),
                todayLogListEl: document.getElementById('today-log-list'),
                weeklyChartEl: document.getElementById('weekly-chart'),
                video: document.getElementById('video'),
                canvas: document.getElementById('canvas'),
                captureBtn: document.getElementById('capture-btn'),
                cameraActivator: document.getElementById('camera-activator'),
                prevMonthBtn: document.getElementById('prev-month-btn'),
                nextMonthBtn: document.getElementById('next-month-btn'),
                monthYearTitle: document.getElementById('month-year-title'),
                calendarBody: document.getElementById('calendar-body'),
                dailyLogDateEl: document.getElementById('daily-log-date'),
                dailyLogListEl: document.getElementById('daily-log-list'),
                dailyLogTotalEl: document.getElementById('daily-log-total'),
                addProductFromLibraryBtn: document.getElementById('add-product-from-library-btn'),
                productLibraryList: document.getElementById('product-library-list'),
                modal: document.getElementById('add-product-modal'),
                textAnalyzerModal: document.getElementById('text-analyzer-modal'),
                customDialog: document.getElementById('custom-dialog'),
                dialogMessage: document.getElementById('dialog-message'),
                dialogOkBtn: document.getElementById('dialog-ok-btn'),
                dialogCancelBtn: document.getElementById('dialog-cancel-btn'),
                textAnalyzerFab: document.getElementById('text-analyzer-fab'),
                confirmationView: document.getElementById('confirmation-view'),
                confirmationImage: document.getElementById('confirmation-image'),
                detailsInput: document.getElementById('details-input'),
                retakePhotoBtn: document.getElementById('retake-photo-btn'),
                analyzeFinalBtn: document.getElementById('analyze-final-btn'),
                toastNotification: document.getElementById('toast-notification'),
            };

            let mealData = {};
            let productLibrary = [];
            let currentDate = new Date();
            let mainStream, modalStream;
            let cameraPermissionGranted = false;
            let lastCapturedImage = null;
            let editMode = false;
            let editProductId = null;
            let newProductData = {};

            function switchView(viewId) {
                if (mainStream) { stopCamera(mainStream); mainStream = null; Quagga.stop(); }
                allElements.appViews.forEach(view => view.classList.remove('active'));
                allElements.navLinks.forEach(l => l.classList.remove('active'));
                const newView = document.getElementById(viewId);
                if(newView) newView.classList.add('active');
                const link = document.querySelector(`.nav-link[data-view="${viewId}"]`);
                if(link) { allElements.headerTitle.textContent = link.textContent; link.classList.add('active'); }
                const isSpecialView = viewId === 'scanner-view' || viewId === 'confirmation-view';
                allElements.fabScanBtn.style.display = isSpecialView ? 'none' : 'flex';
                allElements.textAnalyzerFab.style.display = isSpecialView ? 'none' : 'flex';
                allElements.sideMenu.classList.add('hidden');
                if (viewId === 'today-view') renderTodayView();
                if (viewId === 'calendar-view') renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
                if (viewId === 'library-view') renderProductLibrary();
                if (viewId === 'scanner-view') {
                    allElements.headerTitle.textContent = 'Σάρωση Φαγητού';
                    initializeScannerCamera();
                }
            }
            allElements.menuBtn.addEventListener('click', () => allElements.sideMenu.classList.toggle('hidden'));
            allElements.sideMenu.addEventListener('click', (e) => { if (e.target === allElements.sideMenu) allElements.sideMenu.classList.add('hidden'); });
            allElements.navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); switchView(e.target.dataset.view); }); });
            allElements.fabScanBtn.addEventListener('click', () => switchView('scanner-view'));
            document.body.addEventListener('click', e => { 
                if (e.target.closest('.back-to-calendar-btn')) switchView('calendar-view');
                if (e.target.closest('.back-to-today-btn')) switchView('today-view');
            });
            allElements.textAnalyzerFab.addEventListener('click', () => allElements.textAnalyzerModal.classList.remove('hidden'));
            allElements.textAnalyzerModal.querySelector('.text-analyzer-cancel-btn').addEventListener('click', () => allElements.textAnalyzerModal.classList.add('hidden'));
            allElements.textAnalyzerModal.querySelector('#analyze-text-btn').addEventListener('click', analyzeMealFromText);
            
            document.body.addEventListener('click', async (e) => {
                if (e.target.closest('.delete-meal-btn')) {
                    const btn = e.target.closest('.delete-meal-btn');
                    const date = btn.dataset.date;
                    const id = btn.dataset.id;
                    const confirmed = await showCustomAlert('Είστε σίγουροι για τη διαγραφή αυτού του γεύματος;', true);
                    if (confirmed) deleteMealEntry(date, id);
                }
            });

            function saveData() { localStorage.setItem('mealData', JSON.stringify(mealData)); localStorage.setItem('productLibrary', JSON.stringify(productLibrary)); }
            function loadData() { mealData = JSON.parse(localStorage.getItem('mealData') || '{}'); productLibrary = JSON.parse(localStorage.getItem('productLibrary') || '[]'); }

            function renderTodayView() {
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                renderMealList(allElements.todayLogListEl, dateStr);
                const totalCalories = (mealData[dateStr] || []).reduce((sum, meal) => sum + meal.calories, 0);
                allElements.todayTotalCaloriesEl.textContent = `${totalCalories} kcal`;
                renderWeeklyChart();
            }
            
            function renderWeeklyChart() {
                allElements.weeklyChartEl.innerHTML = '';
                const last7DaysData = []; let maxCalories = 0;
                for (let i = 6; i >= 0; i--) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    const totalCalories = (mealData[dateStr] || []).reduce((sum, meal) => sum + meal.calories, 0);
                    if (totalCalories > maxCalories) maxCalories = totalCalories;
                    last7DaysData.push({ label: d.toLocaleDateString('el-GR', { weekday: 'short' }), calories: totalCalories, isToday: i === 0 });
                }
                if (maxCalories === 0) maxCalories = 2000;
                last7DaysData.forEach(day => {
                    const barHeight = Math.max(1, (day.calories / maxCalories) * 100);
                    const barColor = day.isToday ? 'bg-cyan-400' : 'bg-gray-600';
                    allElements.weeklyChartEl.innerHTML += `<div class="flex flex-col items-center justify-end h-full w-full"><div class="${barColor} w-full rounded-t-md" style="height: ${barHeight}%" title="${day.calories} kcal"></div><div class="text-xs mt-1">${day.label}</div></div>`;
                });
            }

            function renderCalendar(year, month) {
                currentDate = new Date(year, month, 1);
                allElements.calendarBody.innerHTML = '';
                allElements.monthYearTitle.textContent = `${currentDate.toLocaleString('el-GR', { month: 'long' })} ${year}`;
                const firstDayOfMonth = (new Date(year, month, 1).getDay() + 6) % 7;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDayOfMonth; i++) allElements.calendarBody.innerHTML += `<div class="calendar-day"></div>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayMeals = mealData[dateStr] || [];
                    const totalCalories = dayMeals.reduce((sum, meal) => sum + meal.calories, 0);
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day flex flex-col items-center justify-center p-1 border border-gray-700 rounded-md cursor-pointer hover:bg-gray-700';
                    if(dayMeals.length > 0) dayDiv.classList.add('has-entries');
                    dayDiv.innerHTML = `<span class="font-bold">${day}</span>`;
                    if(totalCalories > 0) dayDiv.innerHTML += `<span class="text-xs text-cyan-400">${totalCalories} kcal</span>`;
                    dayDiv.addEventListener('click', () => { renderDailyLog(dateStr); switchView('daily-log-view'); });
                    allElements.calendarBody.appendChild(dayDiv);
                }
            }
            allElements.prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
            allElements.nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
            
            function renderDailyLog(dateStr) {
                const date = new Date(dateStr.replace(/-/g, '/'));
                allElements.dailyLogDateEl.textContent = date.toLocaleDateString('el-GR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                allElements.headerTitle.textContent = 'Ημερήσιο Log';
                renderMealList(allElements.dailyLogListEl, dateStr);
                const totalCalories = (mealData[dateStr] || []).reduce((sum, meal) => sum + meal.calories, 0);
                allElements.dailyLogTotalEl.textContent = `${totalCalories} kcal`;
            }
            
            function renderMealList(listElement, dateStr) {
                const dayMeals = mealData[dateStr] || [];
                listElement.innerHTML = '';
                if (dayMeals.length === 0) { listElement.innerHTML = `<li class="text-gray-500 text-center p-8">Δεν υπάρχουν γεύματα. Πατήστε το '+' για να προσθέσετε.</li>`; }
                else {
                    dayMeals.sort((a,b) => b.id - a.id);
                    dayMeals.forEach(meal => {
                        const li = document.createElement('li');
                        li.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                        li.innerHTML = `<div><p class="font-semibold">${meal.name}</p><p class="text-sm text-gray-400">${meal.time}</p></div><div class="flex items-center"><strong class="text-cyan-400 mr-4">${meal.calories} kcal</strong><button class="delete-meal-btn" data-date="${dateStr}" data-id="${meal.id}"><svg class="w-6 h-6 text-red-500 hover:text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button></div>`;
                        listElement.appendChild(li);
                    });
                }
            }

            function deleteMealEntry(date, id) {
                if (mealData[date]) {
                    mealData[date] = mealData[date].filter(meal => meal.id != id);
                    if (mealData[date].length === 0) delete mealData[date];
                    saveData();
                    const currentView = document.querySelector('.app-view.active').id;
                    if (currentView === 'today-view') renderTodayView();
                    if (currentView === 'daily-log-view') renderDailyLog(date);
                }
            }

            async function startCamera(videoElement, activatorElement = null) {
                try {
                    if (videoElement.srcObject) stopCamera(videoElement.srcObject);
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    videoElement.srcObject = stream;
                    if (activatorElement) activatorElement.classList.add('hidden');
                    videoElement.classList.remove('hidden');
                    if (videoElement.id === 'video') { allElements.captureBtn.disabled = false; document.getElementById('scan-instruction').textContent = 'Σαρώστε ένα φαγητό...'; }
                    return stream;
                } catch (err) {
                    cameraPermissionGranted = false;
                    const message = "Η πρόσβαση στην κάμερα απέτυχε. Ελέγξτε τις άδειες του browser και ανανεώστε τη σελίδα.";
                    if (activatorElement) {
                         activatorElement.innerHTML = `<div class="p-4 text-center"><p class="text-red-400">${message}</p><button id="retry-camera-btn" class="mt-4 bg-blue-600 px-4 py-2 rounded-lg">Δοκιμάστε ξανά</button></div>`;
                         document.getElementById('retry-camera-btn').addEventListener('click', initializeScannerCamera);
                    } else { await showCustomAlert(message); }
                    return null;
                }
            }
            function stopCamera(stream) { if (stream) stream.getTracks().forEach(track => track.stop()); }
            
            async function initializeScannerCamera() {
                const activator = document.getElementById('camera-activator');
                activator.innerHTML = `<div class="spinner w-8 h-8 rounded-full border-4 border-gray-500"></div>`;
                mainStream = await startCamera(allElements.video, activator);
                if (mainStream) {
                    cameraPermissionGranted = true;
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: allElements.video,
                            constraints: { facingMode: "environment" },
                        },
                        decoder: { readers: ["ean_reader", "ean_13_reader", "upc_reader"] }
                    }, (err) => {
                        if (err) { console.error("Quagga initialization failed:", err); return; }
                        Quagga.start();
                    });
                    Quagga.onDetected(handleDetectedBarcode);
                }
            }
            allElements.cameraActivator.addEventListener('click', initializeScannerCamera);
            
            allElements.captureBtn.addEventListener('click', async () => {
                const context = allElements.canvas.getContext('2d');
                allElements.canvas.width = allElements.video.videoWidth; 
                allElements.canvas.height = allElements.video.videoHeight;
                context.drawImage(allElements.video, 0, 0, allElements.canvas.width, allElements.canvas.height);
                lastCapturedImage = allElements.canvas.toDataURL('image/png');
                
                switchView('today-view');
                showToast("έξυπνη σάρωση...");
                
                analyzeImage(lastCapturedImage.split(',')[1]);
            });
            
            async function analyzeImage(base64ImageData) {
                try {
                    const keywordsPrompt = `Describe the main food item in this image with 3-5 simple keywords in English. Respond with ONLY a valid JSON array of strings. Example: ["banana", "fruit", "yellow"]`;
                    const scannedKeywords = await callAI(keywordsPrompt, base64ImageData);
                    let bestMatch = findBestMatch(scannedKeywords);
                    if (bestMatch) {
                        const finalCalories = Math.round((bestMatch.weight / 100) * bestMatch.caloriesPer100g);
                        addEntryToHistory({ name: bestMatch.name, weight: bestMatch.weight, calories: finalCalories });
                    } else {
                        const genericPrompt = `Analyze the food in the image. First, check if a 1 Euro coin is clearly visible next to the food. If YES, estimate the food's weight in grams and respond with {"analysis_type": "coin", "food_name_greek": "Name", "calories_per_100g": 123, "estimated_weight_g": 123}. If NO coin is visible, identify the food and provide calories for a typical medium serving and respond with {"analysis_type": "average", "food_name_greek": "Name", "calories": 123, "weight": 150}. If you cannot identify food, respond with {}.`;
                        const aiResponse = await callAI(genericPrompt, base64ImageData);
                        if (aiResponse.analysis_type === 'coin') {
                            addEntryToHistory({ name: aiResponse.food_name_greek, weight: Math.round(aiResponse.estimated_weight_g), calories: Math.round((aiResponse.estimated_weight_g / 100) * aiResponse.calories_per_100g) });
                        } else if (aiResponse.analysis_type === 'average') {
                            addEntryToHistory({ name: aiResponse.food_name_greek, weight: aiResponse.weight, calories: aiResponse.calories });
                        } else { throw new Error("Could not identify food or match type."); }
                    }
                } catch (e) { await showCustomAlert('Απέτυχε η ανάλυση. Δοκιμάστε ξανά.'); console.error(e); }
            }

            async function handleDetectedBarcode(data) {
                if (isBarcodeScanning) return;
                isBarcodeScanning = true;
                Quagga.stop();
                await showCustomAlert(`Εντοπίστηκε Barcode: ${data.codeResult.code}. Γίνεται αναζήτηση...`);
                try {
                    const response = await fetch(`https://world.openfoodfacts.org/api/v2/product/${data.codeResult.code}.json`);
                    if (!response.ok) throw new Error('Product not found in database.');
                    const productData = await response.json();
                    if (productData.status === 1 && productData.product) {
                        const product = productData.product;
                        const productName = product.product_name_el || product.product_name || 'Άγνωστο Προϊόν';
                        const caloriesPer100g = product.nutriments['energy-kcal_100g'] || 0;
                        const servingSize = parseInt(product.serving_quantity, 10) || 100;
                        const finalCalories = Math.round((servingSize / 100) * caloriesPer100g);
                        addEntryToHistory({ name: productName, weight: servingSize, calories: finalCalories });
                        switchView('today-view');
                    } else {
                        await showCustomAlert('Το προϊόν δεν βρέθηκε στη βάση δεδομένων.');
                        switchView('scanner-view');
                    }
                } catch (e) {
                    await showCustomAlert('Σφάλμα κατά την αναζήτηση του barcode.');
                    console.error(e);
                    switchView('scanner-view');
                } finally {
                    isBarcodeScanning = false;
                }
            }

            function findBestMatch(scannedKeywords) {
                let bestMatch = null;
                let maxMatchCount = 0;
                if (productLibrary.length > 0) {
                    for (const product of productLibrary) {
                        const libraryKeywords = product.keywords || [];
                        const matchCount = scannedKeywords.filter(keyword => libraryKeywords.includes(keyword)).length;
                        if (matchCount > maxMatchCount && matchCount >= 2) { maxMatchCount = matchCount; bestMatch = product; }
                    }
                }
                return bestMatch;
            }

            function addEntryToHistory(entry) {
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                const newMeal = { ...entry, time: timeStr, id: Date.now() };
                if (!mealData[dateStr]) mealData[dateStr] = [];
                mealData[dateStr].push(newMeal);
                saveData();
                renderTodayView();
            }
            
            function showCustomAlert(message, isConfirm = false) { return new Promise(resolve => { allElements.customDialog.classList.remove('hidden'); allElements.customDialog.classList.add('flex'); allElements.dialogMessage.textContent = message; allElements.dialogOkBtn.onclick = () => { allElements.customDialog.classList.add('hidden'); allElements.customDialog.classList.remove('flex'); resolve(true); }; allElements.dialogCancelBtn.onclick = () => { allElements.customDialog.classList.add('hidden'); allElements.customDialog.classList.remove('flex'); resolve(false); }; allElements.dialogCancelBtn.style.display = isConfirm ? 'inline-block' : 'none'; }); }
            function showToast(message, duration = 3000) {
                const toast = document.getElementById('toast-notification');
                toast.textContent = message;
                toast.classList.remove('hidden', 'opacity-0', 'translate-y-4');
                setTimeout(() => { toast.classList.remove('opacity-0'); toast.classList.add('translate-y-0'); }, 10);
                setTimeout(() => { toast.classList.add('opacity-0', 'translate-y-4'); setTimeout(() => toast.classList.add('hidden'), 500);}, duration);
            }
            
            allElements.addProductFromLibraryBtn.addEventListener('click', () => openAddModal(false));
            
            function renderProductLibrary() {
                allElements.productLibraryList.innerHTML = '';
                if (productLibrary.length === 0) { allElements.productLibraryList.innerHTML = `<li class="text-gray-500 text-center">Η βιβλιοθήκη σας είναι άδεια.</li>`; return; }
                productLibrary.forEach(product => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                    li.innerHTML = `<div class="flex items-center space-x-3"><img src="${product.imageBase64}" class="w-12 h-12 rounded-md object-cover"><div><p class="font-semibold">${product.name}</p><p class="text-sm text-gray-400">${product.caloriesPer100g} kcal/100g - ${product.weight}g</p></div></div><div class="flex space-x-2"><button class="edit-product-btn text-sm bg-blue-600 p-2 rounded" data-id="${product.id}">Επεξεργασία</button><button class="delete-product-btn text-sm bg-red-600 p-2 rounded" data-id="${product.id}">Διαγραφή</button></div>`;
                    allElements.productLibraryList.appendChild(li);
                });
                document.querySelectorAll('.edit-product-btn').forEach(btn => btn.addEventListener('click', handleEditProduct));
                document.querySelectorAll('.delete-product-btn').forEach(btn => btn.addEventListener('click', handleDeleteProduct));
            }
            async function handleEditProduct(event) { const product = productLibrary.find(p => p.id === event.target.dataset.id); if (product) openAddModal(true, product); }
            async function handleDeleteProduct(event) { const productId = event.target.dataset.id; const confirmed = await showCustomAlert('Είστε σίγουροι για τη διαγραφή;', true); if (confirmed) { productLibrary = productLibrary.filter(p => p.id !== productId); saveData(); renderProductLibrary(); } }
            
            function showModalStep(step) {
                const stepsContainer = allElements.modal.querySelector('#modal-steps-container');
                stepsContainer.querySelectorAll('.modal-step').forEach(s => s.classList.add('hidden'));
                const currentStep = stepsContainer.querySelector(`#modal-step-${step}`);
                if (currentStep) currentStep.classList.remove('hidden');
                allElements.modal.querySelector('#modal-video-container').style.display = (step === 1 || step === 3) ? 'block' : 'none';
            }

            async function openAddModal(isEditing = false, product = null) {
                editMode = isEditing;
                const m = allElements.modal;
                m.querySelector('#capture-label-btn').onclick = onCaptureLabel;
                m.querySelector('#confirm-data-btn').onclick = onConfirmData;
                m.querySelector('#capture-product-btn').onclick = onCaptureProduct;
                m.querySelector('#save-product-btn').onclick = onSaveProduct;
                m.querySelectorAll('.modal-cancel-btn').forEach(btn => btn.onclick = closeModal);
                m.querySelector('#recapture-product-btn').onclick = () => showModalStep(3);
                if (isEditing && product) {
                    editProductId = product.id;
                    m.querySelector('#calories-input').value = product.caloriesPer100g; m.querySelector('#weight-input').value = product.weight; m.querySelector('#product-name-input').value = product.name; m.querySelector('#product-preview-img').src = product.imageBase64; newProductData = { imageBase64: product.imageBase64, keywords: product.keywords }; m.querySelector('#step2-title').textContent = 'Επεξεργασία Δεδομένων'; m.querySelector('#step4-title').textContent = 'Επεξεργασία Ονόματος'; m.querySelector('#save-product-btn').textContent = 'Αποθήκευση Αλλαγών'; m.querySelector('#recapture-product-btn').classList.remove('hidden');
                } else {
                    editProductId = null;
                    ['#calories-input', '#weight-input', '#product-name-input'].forEach(sel => m.querySelector(sel).value = ''); m.querySelector('#product-preview-img').src = ''; newProductData = {}; m.querySelector('#step2-title').textContent = 'Βήμα 2: Επιβεβαίωση Θερμίδων και Βάρους'; m.querySelector('#step4-title').textContent = 'Βήμα 4: Ονομασία'; m.querySelector('#save-product-btn').textContent = 'Αποθήκευση Προϊόντος'; m.querySelector('#recapture-product-btn').classList.add('hidden');
                }
                m.classList.remove('hidden'); m.classList.add('flex');
                modalStream = await startCamera(m.querySelector('#modal-video'));
                showModalStep(isEditing ? 2 : 1);
            }

            function closeModal() { allElements.modal.classList.add('hidden'); stopCamera(modalStream); modalStream = null; }

            async function onCaptureLabel() {
                const btn = allElements.modal.querySelector('#capture-label-btn');
                btn.textContent = "Ανάλυση..."; btn.disabled = true;
                const context = allElements.canvas.getContext('2d');
                const mVideo = allElements.modal.querySelector('#modal-video');
                allElements.canvas.width = mVideo.videoWidth; allElements.canvas.height = mVideo.videoHeight;
                context.drawImage(mVideo, 0, 0, allElements.canvas.width, allElements.canvas.height);
                const base64ImageData = allElements.canvas.toDataURL('image/png').split(',')[1];
                const prompt = `From the image of this nutrition label, extract the number of calories (kcal) per 100g. Respond with only a single number.`;
                try {
                    const aiResponse = await callAI(prompt, base64ImageData, false);
                    const calories = parseInt(aiResponse, 10);
                    if (isNaN(calories)) throw new Error("Could not parse calories.");
                    allElements.modal.querySelector('#calories-input').value = calories;
                    showModalStep(2);
                } catch (e) { await showCustomAlert("Δεν ήταν δυνατή η ανάγνωση. Εισάγετε χειροκίνητα."); showModalStep(2); } 
                finally { btn.textContent = "Σάρωση Ετικέτας"; btn.disabled = false; }
            }
            async function onConfirmData() {
                const calories = parseInt(allElements.modal.querySelector('#calories-input').value, 10);
                const weight = parseInt(allElements.modal.querySelector('#weight-input').value, 10);
                if(isNaN(calories) || isNaN(weight) || calories <= 0 || weight <= 0) { await showCustomAlert("Εισάγετε έγκυρες τιμές."); return; }
                newProductData.caloriesPer100g = calories; newProductData.weight = weight;
                showModalStep(3);
            }
            async function onCaptureProduct() {
                const context = allElements.canvas.getContext('2d');
                const mVideo = allElements.modal.querySelector('#modal-video');
                allElements.canvas.width = mVideo.videoWidth; allElements.canvas.height = mVideo.videoHeight;
                context.drawImage(mVideo, 0, 0, allElements.canvas.width, allElements.canvas.height);
                newProductData.imageBase64 = allElements.canvas.toDataURL('image/png');
                allElements.modal.querySelector('#product-preview-img').src = newProductData.imageBase64;
                showModalStep(4);
            }
            async function onSaveProduct() {
                const name = allElements.modal.querySelector('#product-name-input').value.trim();
                const calories = parseInt(allElements.modal.querySelector('#calories-input').value, 10);
                const weight = parseInt(allElements.modal.querySelector('#weight-input').value, 10);
                if (!name || isNaN(calories) || isNaN(weight)) { await showCustomAlert("Συμπληρώστε όλα τα πεδία."); return; }
                const btn = allElements.modal.querySelector('#save-product-btn');
                btn.textContent = "Ανάλυση εικόνας..."; btn.disabled = true;
                const keywordsPrompt = `Describe the food item in this image with 3-5 simple keywords in English. Respond with ONLY a valid JSON array of strings. Example: ["protein bar", "chocolate", "nuts"]`;
                try {
                    const keywords = await callAI(keywordsPrompt, newProductData.imageBase64.split(',')[1]);
                    newProductData.keywords = keywords;
                    if (editMode && editProductId) {
                        const idx = productLibrary.findIndex(p => p.id === editProductId);
                        if (idx !== -1) { productLibrary[idx] = {...productLibrary[idx], name, caloriesPer100g: calories, weight, keywords: newProductData.keywords, imageBase64: newProductData.imageBase64 || productLibrary[idx].imageBase64 }; }
                        await showCustomAlert('Οι αλλαγές αποθηκεύτηκαν!');
                    } else {
                        productLibrary.push({ id: `prod_${Date.now()}`, name, caloriesPer100g: calories, weight, imageBase64: newProductData.imageBase64, keywords: newProductData.keywords });
                        await showCustomAlert(`Το προϊόν "${name}" αποθηκεύτηκε!`);
                    }
                    saveData(); closeModal(); switchView('library-view'); renderProductLibrary();
                } catch(e) { await showCustomAlert('Απέτυχε η δημιουργία οπτικής περιγραφής. Το προϊόν δεν αποθηκεύτηκε.'); } 
                finally { btn.textContent = "Αποθήκευση"; btn.disabled = false; }
            }

            async function callAI(prompt, base64ImageData, expectJson = true) {
                const parts = [{ text: prompt }];
                if (base64ImageData) {
                    parts.push({ inlineData: { mimeType: "image/png", data: base64ImageData } });
                }
                const payload = { contents: [{ role: "user", parts: parts }]};
                if(expectJson) payload.generationConfig = { responseMimeType: "application/json" };
                const apiKey = "AIzaSyCc3SAooOx7gLDPcWZeKrpCC-iBDDpq1Gc";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!aiResponseText) throw new Error("No response from AI.");
                return expectJson ? JSON.parse(aiResponseText) : aiResponseText;
            }
            
            async function analyzeMealFromText() {
                const description = document.getElementById('text-analyzer-input').value;
                if (!description.trim()) { await showCustomAlert('Παρακαλώ εισάγετε μια περιγραφή.'); return; }
                const btn = document.getElementById('analyze-text-btn');
                btn.textContent = 'Ανάλυση...'; btn.disabled = true;
                const prompt = `You are a nutrition expert. The user will provide a meal description in Greek. Your task is to analyze the description, paying close attention to quantities mentioned (e.g., '2 slices', 'large portion'). The user input is: "${description}". Respond with ONLY a valid JSON object with the following structure: {"meal_name": "A summary name for the meal in Greek", "total_calories": a number, "estimated_weight": a number representing total grams}.`;
                try {
                    const aiResponse = await callAI(prompt, null, true);
                    if (!aiResponse.meal_name || typeof aiResponse.total_calories !== 'number') throw new Error("Invalid response structure from AI.");
                    addEntryToHistory({ name: aiResponse.meal_name, weight: aiResponse.estimated_weight, calories: aiResponse.total_calories });
                    document.getElementById('text-analyzer-modal').classList.add('hidden');
                    document.getElementById('text-analyzer-input').value = '';
                    switchView('today-view');
                } catch (e) { await showCustomAlert('Απέτυχε η ανάλυση του γεύματος. Προσπαθήστε να είστε πιο περιγραφικός.'); console.error("Text Analysis Error:", e); } 
                finally { btn.textContent = 'Ανάλυση & Προσθήκη'; btn.disabled = false; }
            }
            
            document.body.addEventListener('click', e => { if (e.target.matches('#add-product-from-library-btn')) openAddModal(false); });
            
            loadData();
            switchView('today-view');
        });
    </script>
</body>
</html>
