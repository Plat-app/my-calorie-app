<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Μετρητής Θερμίδων v12.4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .app-view { display: none; }
        .app-view.active { display: block; animation: fadeIn 0.3s; }
        #video-container, #modal-video-container {
            position: relative; width: 100%;
            aspect-ratio: 1 / 1; /* Αλλαγή σε τετράγωνο */
            overflow: hidden;
            border-radius: 1.5rem; background-color: #000;
        }
        #video, #modal-video { width: 100%; height: 100%; object-fit: cover; }
        .shutter-button:active { transform: scale(0.95); }
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .calendar-grid { grid-template-columns: repeat(7, minmax(0, 1fr)); }
        .calendar-day { aspect-ratio: 1 / 1; }
        .calendar-day.has-entries { background-color: rgba(52, 211, 153, 0.2); border: 1px solid #34d399; }
        .nav-link.active { background-color: #4a5568; }
        .fab {
            position: fixed;
            bottom: 1.5rem;
            z-index: 30;
        }
        .chart-day-wrapper { transition: background-color 0.2s; }
        .chart-day-wrapper:hover { background-color: rgba(74, 85, 104, 0.3); border-radius: 0.5rem; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <header class="bg-gray-800 p-4 flex items-center justify-between sticky top-0 z-40">
        <h1 id="header-title" class="text-xl font-bold text-cyan-400">Σήμερα</h1>
        <button id="menu-btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
        </button>
    </header>

    <div id="side-menu" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50">
        <nav class="bg-gray-800 w-64 h-full p-4 space-y-2">
            <a href="#" class="nav-link block p-2 rounded" data-view="today-view">Σήμερα</a>
            <a href="#" class="nav-link block p-2 rounded" data-view="calendar-view">Το Ημερολόγιό μου</a>
            <a href="#" class="nav-link block p-2 rounded" data-view="library-view">Η Βιβλιοθήκη μου</a>
        </nav>
    </div>

    <main class="p-4">
        <div id="today-view" class="app-view active max-w-md mx-auto">
            <div class="bg-gray-800 rounded-3xl shadow-2xl p-6 mb-4">
                <h2 class="text-lg font-semibold text-gray-300 mb-4">Επισκόπηση 7 Ημερών</h2>
                <div id="weekly-chart" class="h-48 flex justify-between items-end space-x-1"></div>
            </div>
            <div class="bg-gray-800 rounded-3xl shadow-2xl p-6 mb-4">
                <p class="text-gray-400">Σύνολο Θερμίδων</p>
                <p id="today-total-calories" class="text-5xl font-bold text-cyan-400">0 kcal</p>
            </div>
            <h2 id="today-log-list-title" class="text-lg font-semibold mb-2">Γεύματα Ημέρας</h2>
            <ul id="today-log-list" class="space-y-2 pb-24"></ul>
        </div>
        
        <div id="scanner-view" class="app-view max-w-md mx-auto">
            <button class="back-to-today-btn text-cyan-400 mb-4">&lt; Επιστροφή στο Σήμερα</button>
             <div class="bg-gray-800 rounded-3xl shadow-2xl p-6 mb-4">
                <div id="video-container" class="mb-2 shadow-lg">
                    <div id="camera-activator" class="absolute inset-0 bg-gray-700 flex flex-col items-center justify-center rounded-2xl z-10 cursor-pointer hover:bg-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-500 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <p class="text-white font-semibold">Ενεργοποίηση Κάμερας</p>
                    </div>
                    <video id="video" class="hidden" playsinline autoplay muted></video>
                </div>
                <p id="scan-instruction" class="text-center text-xs text-amber-400 mb-4 bg-gray-700/50 p-2 rounded-lg">Ενεργοποιήστε την κάμερα για να ξεκινήσετε.</p>
                <canvas id="canvas" class="hidden"></canvas>
                <div class="flex justify-center mb-6"><button id="capture-btn" class="shutter-button transition-all w-20 h-20 bg-white rounded-full border-4 border-gray-500 flex items-center justify-center focus:outline-none" disabled><div class="w-16 h-16 bg-white rounded-full border-2 border-gray-900"></div></button></div>
            </div>
        </div>

        <div id="confirmation-view" class="app-view max-w-md mx-auto">
            <h2 class="text-2xl font-bold mb-4">Επιβεβαίωση Γεύματος</h2>
            <div class="bg-gray-800 rounded-3xl shadow-2xl p-6 mb-4">
                <div class="w-full bg-black rounded-2xl overflow-hidden mb-4" style="aspect-ratio: 1 / 1;">
                    <img id="confirmation-image" src="" class="w-full h-full object-cover">
                </div>
                <label for="meal-details" class="block text-sm font-medium text-gray-300 mb-2">Πρόσθετες Λεπτομέρειες (Προαιρετικά)</label>
                <textarea id="meal-details" class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-white" rows="3" placeholder="π.χ. χωρίς τηγανητές πατάτες, με έξτρα σως..."></textarea>
            </div>
            <button id="analyze-confirmation-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg mb-2">Ανάλυση Γεύματος</button>
            <button id="cancel-confirmation-btn" class="w-full text-gray-400 hover:text-white font-bold py-2 px-4 rounded-lg">Άκυρο</button>
        </div>

        <div id="calendar-view" class="app-view max-w-md mx-auto">
            <div class="flex justify-between items-center mb-4"><button id="prev-month-btn" class="p-2 rounded-full bg-gray-700">&lt;</button><h2 id="month-year-title" class="text-xl font-semibold"></h2><button id="next-month-btn" class="p-2 rounded-full bg-gray-700">&gt;</button></div>
            <div class="grid calendar-grid text-center font-semibold text-xs text-gray-400 mb-2"><div>ΔΕΥ</div><div>ΤΡΙ</div><div>ΤΕΤ</div><div>ΠΕΜ</div><div>ΠΑΡ</div><div>ΣΑΒ</div><div>ΚΥΡ</div></div>
            <div id="calendar-body" class="grid calendar-grid gap-1"></div>
        </div>
        
        <div id="daily-log-view" class="app-view max-w-md mx-auto">
             <button class="back-to-calendar-btn text-cyan-400 mb-4">&lt; Επιστροφή στο Ημερολόγιο</button>
             <h2 id="daily-log-date" class="text-2xl font-bold mb-4"></h2>
             <ul id="daily-log-list" class="space-y-2 mb-4"></ul>
             <div class="bg-gray-700 p-4 rounded-lg text-right"><p class="text-gray-400">Σύνολο Ημέρας:</p><p id="daily-log-total" class="text-2xl font-bold text-cyan-400"></p></div>
        </div>
        
        <div id="library-view" class="app-view max-w-md mx-auto">
             <button id="add-product-from-library-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg mb-4">+ Προσθήκη Νέου Προϊόντος</button>
            <ul id="product-library-list" class="space-y-3 pb-24"></ul>
        </div>
    </main>

    <button id="text-analyzer-fab" class="fab left-6 w-14 h-14 bg-green-600 rounded-full flex items-center justify-center text-white shadow-lg hover:bg-green-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
    </button>
    <button id="fab-scan-btn" class="fab right-6 w-16 h-16 bg-blue-600 rounded-full flex items-center justify-center text-white shadow-lg hover:bg-blue-700">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
    </button>

    <div id="add-product-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl w-full max-w-md p-6 flex flex-col">
            <div id="modal-video-container" class="mb-4"><video id="modal-video" class="rounded-lg" playsinline autoplay muted></video></div>
            <div id="modal-steps-container">
                <div id="modal-step-1" class="modal-step"><h2 class="text-xl font-bold mb-2">Βήμα 1: Σάρωση Ετικέτας</h2><p class="text-sm text-gray-400 mb-4">Για καλύτερη εστίαση, πατήστε στην οθόνη πριν τη λήψη.</p><button id="capture-label-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Σάρωση Ετικέtas</button><button class="modal-cancel-btn w-full mt-2 text-gray-400">Άκυρο</button></div>
                <div id="modal-step-2" class="hidden modal-step"><h2 id="step2-title" class="text-xl font-bold mb-2">Βήμα 2: Επιβεβαίωση Θερμίδων και Βάρους</h2><div class="mb-4"><label for="calories-input" class="block text-sm font-medium text-gray-300">Θερμίδες ανά 100g (kcal)</label><input type="number" id="calories-input" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white"></div><div class="mb-4"><label for="weight-input" class="block text-sm font-medium text-gray-300">Βάρος προϊόντος (g)</label><input type="number" id="weight-input" placeholder="π.χ. 60" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white"></div><button id="confirm-data-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Επόμενο Βήμα</button><button class="modal-cancel-btn w-full mt-2 text-gray-400">Άκυρο</button></div>
                <div id="modal-step-3" class="hidden modal-step"><h2 class="text-xl font-bold mb-2">Βήμα 3: Φωτογράφιση Προϊόντος</h2><p class="text-sm text-gray-400 mb-4">Τώρα, φωτογραφίστε το ίδιο το προϊόν, καθαρά και μόνο του.</p><button id="capture-product-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg">Φωτογράφιση Προϊόντος</button><button class="modal-cancel-btn w-full mt-2 text-gray-400">Άκυρο</button></div>
                <div id="modal-step-4" class="hidden modal-step"><h2 id="step4-title" class="text-xl font-bold mb-2">Βήμα 4: Ονομασία</h2><div class="mb-4"><img id="product-preview-img" src="" class="rounded-lg max-h-32 mx-auto mb-2"><button id="recapture-product-btn" class="hidden text-sm text-blue-400 hover:text-blue-300 mb-2">Νέα Φωτογραφία</button><label for="product-name-input" class="block text-sm font-medium text-gray-300">Δώστε ένα όνομα στο προϊόν σας</label><input type="text" id="product-name-input" placeholder="π.χ. Η μπάρα μου" class="mt-1 block w-full bg-gray-700 border-gray-600 rounded-md shadow-sm py-2 px-3 text-white"></div><button id="save-product-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg">Αποθήκευση</button><button class="modal-cancel-btn w-full mt-2 text-gray-400">Άκυρο</button></div>
            </div>
        </div>
    </div>
    <div id="text-analyzer-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-2xl w-full max-w-md p-6 flex flex-col">
            <h2 class="text-xl font-bold mb-2">✨ Αναλυτής Γεύματος</h2>
            <p class="text-sm text-gray-400 mb-4">Περιγράψτε το γεύμα σας (π.χ. "Σαλάτα με κοτόπουλο και σως").</p>
            <textarea id="text-analyzer-input" class="w-full bg-gray-700 border-gray-600 rounded-md shadow-sm p-2 text-white" rows="4"></textarea>
            <button id="analyze-text-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-lg mt-4">Ανάλυση & Προσθήκη</button>
            <button class="text-analyzer-cancel-btn w-full mt-2 text-gray-400">Άκυρο</button>
        </div>
    </div>
    <div id="custom-dialog" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50"><div class="bg-gray-700 rounded-lg p-6 max-w-sm w-full text-center"><p id="dialog-message" class="text-white mb-6"></p><div id="dialog-buttons" class="flex justify-center space-x-4"><button id="dialog-ok-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg">OK</button><button id="dialog-cancel-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-5 rounded-lg">Άκυρο</button></div></div></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const headerTitle = document.getElementById('header-title');
            const menuBtn = document.getElementById('menu-btn');
            const sideMenu = document.getElementById('side-menu');
            const navLinks = document.querySelectorAll('.nav-link');
            const appViews = document.querySelectorAll('.app-view');
            const fabScanBtn = document.getElementById('fab-scan-btn');
            const todayTotalCaloriesEl = document.getElementById('today-total-calories');
            const todayLogListEl = document.getElementById('today-log-list');
            const todayLogListTitleEl = document.getElementById('today-log-list-title');
            const weeklyChartEl = document.getElementById('weekly-chart');
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const captureBtn = document.getElementById('capture-btn');
            const cameraActivator = document.getElementById('camera-activator');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const monthYearTitle = document.getElementById('month-year-title');
            const calendarBody = document.getElementById('calendar-body');
            const dailyLogDateEl = document.getElementById('daily-log-date');
            const dailyLogListEl = document.getElementById('daily-log-list');
            const dailyLogTotalEl = document.getElementById('daily-log-total');
            const addProductFromLibraryBtn = document.getElementById('add-product-from-library-btn');
            const productLibraryList = document.getElementById('product-library-list');
            const modal = document.getElementById('add-product-modal');
            const textAnalyzerModal = document.getElementById('text-analyzer-modal');
            const customDialog = document.getElementById('custom-dialog');
            const dialogMessage = document.getElementById('dialog-message');
            const dialogOkBtn = document.getElementById('dialog-ok-btn');
            const dialogCancelBtn = document.getElementById('dialog-cancel-btn');
            const textAnalyzerFab = document.getElementById('text-analyzer-fab');
            const confirmationImage = document.getElementById('confirmation-image');
            const mealDetailsInput = document.getElementById('meal-details');
            const analyzeConfirmationBtn = document.getElementById('analyze-confirmation-btn');
            const cancelConfirmationBtn = document.getElementById('cancel-confirmation-btn');
            
            // State
            let mealData = {};
            let productLibrary = [];
            let currentDate = new Date();
            let mainStream, modalStream;
            let capturedImageData = null;
            let selectedDateStr = null; // Holds 'YYYY-MM-DD' of the selected day in the chart

            // --- Core Functions ---

            function saveData() { localStorage.setItem('mealData', JSON.stringify(mealData)); localStorage.setItem('productLibrary', JSON.stringify(productLibrary)); }
            function loadData() { mealData = JSON.parse(localStorage.getItem('mealData') || '{}'); productLibrary = JSON.parse(localStorage.getItem('productLibrary') || '[]'); }

            // --- View Switching ---

            function switchView(viewId) {
                if (mainStream && viewId !== 'confirmation-view') { stopCamera(mainStream); mainStream = null; }
                appViews.forEach(view => view.classList.remove('active'));
                const newView = document.getElementById(viewId);
                if(newView) newView.classList.add('active');
                
                const isScannerRelated = viewId === 'scanner-view' || viewId === 'confirmation-view';
                fabScanBtn.style.display = isScannerRelated ? 'none' : 'flex';
                textAnalyzerFab.style.display = isScannerRelated ? 'none' : 'flex';
                sideMenu.classList.add('hidden');

                const link = document.querySelector(`.nav-link[data-view="${viewId}"]`);
                if (link) {
                    headerTitle.textContent = link.textContent;
                    document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                }

                if (viewId === 'today-view') { headerTitle.textContent = 'Σήμερα'; renderTodayView(); }
                if (viewId === 'calendar-view') renderCalendar(currentDate.getFullYear(), currentDate.getMonth());
                if (viewId === 'library-view') renderProductLibrary();
                if (viewId === 'scanner-view') { headerTitle.textContent = 'Σάρωση Φαγητού'; initializeScannerCamera(); }
                if (viewId === 'confirmation-view') { headerTitle.textContent = 'Επιβεβαίωση'; }
            }
            
            // --- "Today" View Functions (Now Interactive) ---

            function renderTodayView() {
                const now = new Date();
                selectedDateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                renderWeeklyChart();
                updateDayDetails(selectedDateStr);
            }

            function updateDayDetails(dateStr) {
                const totalCalories = (mealData[dateStr] || []).reduce((sum, meal) => sum + meal.calories, 0);
                todayTotalCaloriesEl.textContent = `${totalCalories} kcal`;

                const dateObj = new Date(dateStr.replace(/-/g, '/'));
                const todayObj = new Date();
                todayObj.setHours(0, 0, 0, 0);
                dateObj.setHours(0, 0, 0, 0);

                if (dateObj.getTime() === todayObj.getTime()) {
                    todayLogListTitleEl.textContent = 'Γεύματα Ημέρας';
                } else {
                    todayLogListTitleEl.textContent = `Γεύματα για ${dateObj.toLocaleDateString('el-GR', { day: '2-digit', month: '2-digit' })}`;
                }
                renderMealList(todayLogListEl, dateStr);
            }

            function renderWeeklyChart() {
                weeklyChartEl.innerHTML = '';
                const last7DaysData = [];
                let maxCalories = 0;

                for (let i = 6; i >= 0; i--) {
                    const d = new Date(); d.setDate(d.getDate() - i);
                    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
                    const totalCalories = (mealData[dateStr] || []).reduce((sum, meal) => sum + meal.calories, 0);
                    if (totalCalories > maxCalories) maxCalories = totalCalories;
                    last7DaysData.push({ dateStr: dateStr, label: d.toLocaleDateString('el-GR', { weekday: 'short' }), calories: totalCalories });
                }
                if (maxCalories === 0) maxCalories = 2000;

                last7DaysData.forEach(day => {
                    const barHeightPercent = Math.max(0.5, (day.calories / maxCalories) * 100);
                    const barColor = day.dateStr === selectedDateStr ? 'bg-cyan-400' : 'bg-gray-600';
                    
                    const dayWrapper = document.createElement('div');
                    dayWrapper.className = 'chart-day-wrapper flex-1 flex flex-col items-center h-full cursor-pointer p-1';
                    dayWrapper.dataset.date = day.dateStr;

                    const barAndTextContainer = document.createElement('div');
                    barAndTextContainer.className = 'relative w-full flex-grow flex items-end';

                    barAndTextContainer.innerHTML = `
                        <div class="absolute text-xs text-gray-400 text-center w-full pointer-events-none" style="bottom: ${barHeightPercent}%; margin-bottom: 4px;">
                            ${day.calories > 0 ? day.calories : ''}
                        </div>
                        <div class="${barColor} w-full rounded-t-md" style="height: ${barHeightPercent}%" title="${day.calories} kcal"></div>
                    `;

                    const dayLabel = document.createElement('div');
                    dayLabel.className = 'text-xs mt-1';
                    dayLabel.textContent = day.label;
                    
                    dayWrapper.appendChild(barAndTextContainer);
                    dayWrapper.appendChild(dayLabel);
                    weeklyChartEl.appendChild(dayWrapper);
                });
            }

            // --- Meal List and Entry Management ---

            function renderMealList(listElement, dateStr) {
                const dayMeals = mealData[dateStr] || [];
                listElement.innerHTML = '';
                if (dayMeals.length === 0) { listElement.innerHTML = `<li class="text-gray-500 text-center p-8">Δεν υπάρχουν γεύματα. Πατήστε το '+' για να προσθέσετε.</li>`; }
                else {
                    dayMeals.sort((a,b) => b.time.localeCompare(a.time));
                    dayMeals.forEach(meal => {
                        const li = document.createElement('li');
                        li.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                        li.innerHTML = `<div><p class="font-semibold">${meal.name}</p><p class="text-sm text-gray-400">${meal.time}</p></div><div class="flex items-center"><strong class="text-cyan-400 mr-4">${meal.calories} kcal</strong><button class="delete-meal-btn" data-date="${dateStr}" data-time="${meal.time}"><svg class="w-6 h-6 text-red-500 hover:text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd"></path></svg></button></div>`;
                        listElement.appendChild(li);
                    });
                }
            }

            function addEntryToHistory(entry) {
                const now = new Date();
                const dateStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                const timeStr = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
                const newMeal = { ...entry, time: timeStr, id: `meal_${Date.now()}`};
                if (!mealData[dateStr]) mealData[dateStr] = [];
                mealData[dateStr].push(newMeal);
                saveData();
                showCustomAlert(`"${entry.name}" προστέθηκε!`);
                
                const currentView = document.querySelector('.app-view.active').id;
                if (currentView === 'today-view') { renderTodayView(); }
            }

            function deleteMealEntry(date, time) {
                if (mealData[date]) {
                    mealData[date] = mealData[date].filter(meal => meal.time !== time);
                    if (mealData[date].length === 0) delete mealData[date];
                    saveData();
                    const currentView = document.querySelector('.app-view.active').id;
                    if (currentView === 'today-view') {
                        renderWeeklyChart();
                        updateDayDetails(selectedDateStr);
                    }
                    if (currentView === 'daily-log-view') renderDailyLog(date);
                }
            }

            // --- Camera and Scanner Flow ---
            
            async function startCamera(videoElement, activatorElement = null) {
                try {
                    if (videoElement.srcObject) stopCamera(videoElement.srcObject);
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    videoElement.srcObject = stream;
                    if (activatorElement) activatorElement.classList.add('hidden');
                    videoElement.classList.remove('hidden');
                    if (videoElement.id === 'video') { captureBtn.disabled = false; document.getElementById('scan-instruction').textContent = 'Σαρώστε ένα φαγητό...'; }
                    return stream;
                } catch (err) {
                    const message = "Η πρόσβαση στην κάμερα απέτυχε. Ελέγξτε τις άδειες του browser και ανανεώστε τη σελίδα.";
                    if (activatorElement) {
                         activatorElement.innerHTML = `<div class="p-4 text-center"><p class="text-red-400">${message}</p><button id="retry-camera-btn" class="mt-4 bg-blue-600 px-4 py-2 rounded-lg">Δοκιμάστε ξανά</button></div>`;
                         document.getElementById('retry-camera-btn').addEventListener('click', initializeScannerCamera);
                    } else { await showCustomAlert(message); }
                    return null;
                }
            }

            function stopCamera(stream) { if (stream) stream.getTracks().forEach(track => track.stop()); }
            
            async function initializeScannerCamera() {
                const activator = document.getElementById('camera-activator');
                activator.innerHTML = `<div class="spinner w-8 h-8 rounded-full border-4 border-gray-500"></div>`;
                mainStream = await startCamera(video, activator);
            }

            // --- Event Listeners ---
            
            menuBtn.addEventListener('click', () => sideMenu.classList.toggle('hidden'));
            sideMenu.addEventListener('click', (e) => { if (e.target === sideMenu) sideMenu.classList.add('hidden'); });
            navLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); switchView(e.target.dataset.view); }); });
            fabScanBtn.addEventListener('click', () => switchView('scanner-view'));
            textAnalyzerFab.addEventListener('click', () => textAnalyzerModal.classList.remove('hidden'));
            document.querySelector('.text-analyzer-cancel-btn').addEventListener('click', () => textAnalyzerModal.classList.add('hidden'));
            document.getElementById('analyze-text-btn').addEventListener('click', analyzeMealFromText);
            cameraActivator.addEventListener('click', initializeScannerCamera);
            
            document.body.addEventListener('click', async (e) => {
                if (e.target.closest('.delete-meal-btn')) {
                    const btn = e.target.closest('.delete-meal-btn');
                    const date = btn.dataset.date;
                    const time = btn.dataset.time;
                    const confirmed = await showCustomAlert('Είστε σίγουροι για τη διαγραφή αυτού του γεύματος;', true);
                    if (confirmed) {
                        deleteMealEntry(date, time);
                    }
                }
                if (e.target.closest('.back-to-calendar-btn')) switchView('calendar-view');
                if (e.target.closest('.back-to-today-btn')) switchView('today-view');
            });

            weeklyChartEl.addEventListener('click', (e) => {
                const dayWrapper = e.target.closest('.chart-day-wrapper');
                if (dayWrapper && dayWrapper.dataset.date) {
                    selectedDateStr = dayWrapper.dataset.date;
                    renderWeeklyChart();
                    updateDayDetails(selectedDateStr);
                }
            });

            captureBtn.addEventListener('click', () => {
                const context = canvas.getContext('2d');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                capturedImageData = canvas.toDataURL('image/png');
                confirmationImage.src = capturedImageData;
                switchView('confirmation-view');
            });

            analyzeConfirmationBtn.addEventListener('click', async () => {
                if (!capturedImageData) return;
                switchView('today-view');
                showCustomAlert('Έξυπνη ανάλυση σε εξέλιξη...');
                const base64Only = capturedImageData.split(',')[1];
                const userNotes = mealDetailsInput.value.trim();
                try {
                    let bestMatch = null;
                    const keywordsPrompt = `Describe the main food item in this image with 3-5 simple keywords in English. Respond with ONLY a valid JSON array of strings.`;
                    const scannedKeywords = await callAI(keywordsPrompt, base64Only);
                    bestMatch = findBestMatch(scannedKeywords);

                    if (bestMatch) {
                        const finalCalories = Math.round((bestMatch.weight / 100) * bestMatch.caloriesPer100g);
                        addEntryToHistory({ name: bestMatch.name, weight: bestMatch.weight, calories: finalCalories });
                    } else {
                        const genericPrompt = `Analyze the image. Use the user's notes for context: "${userNotes}". If a 1 Euro coin is visible, use its known diameter (23.25mm) as a scale reference to estimate the food's real-world size, and then its weight and total calories. If no coin is visible, or if multiple distinct items are present, identify each item, count them, estimate the calories per item, and sum them up. Respond with {"food_name_greek": "Name", "calories": 123, "weight": 150}. If you cannot identify food, respond with {}.`;
                        const aiResponse = await callAI(genericPrompt, base64Only);
                        if (aiResponse.calories) {
                            addEntryToHistory({ name: aiResponse.food_name_greek, weight: aiResponse.weight, calories: aiResponse.calories });
                        } else { throw new Error("Could not identify food."); }
                    }
                } catch (e) {
                    showCustomAlert('Απέτυχε η ανάλυση. Δοκιμάστε ξανά με πιο καθαρή εικόνα.');
                    console.error(e);
                } finally {
                    capturedImageData = null;
                    mealDetailsInput.value = '';
                }
            });

            cancelConfirmationBtn.addEventListener('click', () => {
                capturedImageData = null;
                mealDetailsInput.value = '';
                switchView('scanner-view');
            });
            
            // --- AI & Analysis Functions ---
            
            async function callAI(prompt, base64ImageData, expectJson = true) {
                const parts = [{ text: prompt }];
                if (base64ImageData) { parts.push({ inlineData: { mimeType: "image/png", data: base64ImageData } }); }
                const payload = { contents: [{ role: "user", parts: parts }]};
                if(expectJson) payload.generationConfig = { responseMimeType: "application/json" };
                const apiKey = "AIzaSyCc3SAooOx7gLDPcWZeKrpCC-iBDDpq1Gc";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const aiResponseText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                if (!aiResponseText) throw new Error("No response from AI.");
                return expectJson ? JSON.parse(aiResponseText) : aiResponseText;
            }

            function findBestMatch(scannedKeywords) {
                let bestMatch = null;
                let maxMatchCount = 0;
                if (productLibrary.length > 0 && Array.isArray(scannedKeywords)) {
                    for (const product of productLibrary) {
                        const libraryKeywords = product.keywords || [];
                        const matchCount = scannedKeywords.filter(keyword => libraryKeywords.includes(keyword)).length;
                        if (matchCount > maxMatchCount && matchCount >= 2) { maxMatchCount = matchCount; bestMatch = product; }
                    }
                }
                return bestMatch;
            }

            async function analyzeMealFromText() {
                const description = document.getElementById('text-analyzer-input').value;
                if (!description.trim()) { await showCustomAlert('Παρακαλώ εισάγετε μια περιγραφή.'); return; }
                const btn = document.getElementById('analyze-text-btn');
                btn.textContent = 'Ανάλυση...'; btn.disabled = true;
                const prompt = `You are a nutrition expert. The user will provide a meal description in Greek. Your task is to analyze the description, identify the ingredients, estimate their quantities for a typical serving, and calculate the total calories. The user input is: "${description}". Respond with ONLY a valid JSON object with the following structure: {"meal_name": "A summary name for the meal in Greek", "total_calories": a number, "estimated_weight": a number representing total grams}.`;
                try {
                    const aiResponse = await callAI(prompt, null, true);
                    const { meal_name, total_calories, estimated_weight } = aiResponse;
                    if (!meal_name || !total_calories || !estimated_weight) throw new Error("Invalid response structure from AI.");
                    addEntryToHistory({ name: meal_name, weight: estimated_weight, calories: total_calories });
                    document.getElementById('text-analyzer-modal').classList.add('hidden');
                    document.getElementById('text-analyzer-input').value = '';
                    switchView('today-view');
                } catch (e) { await showCustomAlert('Απέτυχε η ανάλυση του γεύματος. Προσπαθήστε να είστε πιο περιγραφικός.'); console.error("Text Analysis Error:", e); } 
                finally { btn.textContent = 'Ανάλυση & Προσθήκη'; btn.disabled = false; }
            }

            // --- Calendar and Daily Log Functions ---

            function renderCalendar(year, month) {
                currentDate = new Date(year, month, 1);
                calendarBody.innerHTML = '';
                monthYearTitle.textContent = `${currentDate.toLocaleString('el-GR', { month: 'long' })} ${year}`;
                const firstDayOfMonth = (new Date(year, month, 1).getDay() + 6) % 7;
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let i = 0; i < firstDayOfMonth; i++) calendarBody.innerHTML += `<div class="calendar-day"></div>`;
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayMeals = mealData[dateStr] || [];
                    const totalCalories = dayMeals.reduce((sum, meal) => sum + meal.calories, 0);
                    const dayDiv = document.createElement('div');
                    dayDiv.className = 'calendar-day flex flex-col items-center justify-center p-1 border border-gray-700 rounded-md cursor-pointer hover:bg-gray-700';
                    if(dayMeals.length > 0) dayDiv.classList.add('has-entries');
                    dayDiv.innerHTML = `<span class="font-bold">${day}</span>`;
                    if(totalCalories > 0) dayDiv.innerHTML += `<span class="text-xs text-cyan-400">${totalCalories} kcal</span>`;
                    dayDiv.addEventListener('click', () => { renderDailyLog(dateStr); switchView('daily-log-view'); });
                    calendarBody.appendChild(dayDiv);
                }
            }
            prevMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
            nextMonthBtn.addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(currentDate.getFullYear(), currentDate.getMonth()); });
            
            function renderDailyLog(dateStr) {
                const date = new Date(dateStr.replace(/-/g, '/'));
                dailyLogDateEl.textContent = date.toLocaleDateString('el-GR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                headerTitle.textContent = 'Ημερήσιο Log';
                renderMealList(dailyLogListEl, dateStr);
                const totalCalories = (mealData[dateStr] || []).reduce((sum, meal) => sum + meal.calories, 0);
                dailyLogTotalEl.textContent = `${totalCalories} kcal`;
            }

            // --- Library Functions ---
            
            function renderProductLibrary() {
                productLibraryList.innerHTML = '';
                if (productLibrary.length === 0) { productLibraryList.innerHTML = `<li class="text-gray-500 text-center">Η βιβλιοθήκη σας είναι άδεια.</li>`; return; }
                productLibrary.forEach(product => {
                    const li = document.createElement('li');
                    li.className = 'bg-gray-700 p-3 rounded-lg flex justify-between items-center';
                    li.innerHTML = `<div class="flex items-center space-x-3"><img src="${product.imageBase64}" class="w-12 h-12 rounded-md object-cover"><div><p class="font-semibold">${product.name}</p><p class="text-sm text-gray-400">${product.caloriesPer100g} kcal/100g - ${product.weight}g</p></div></div><div class="flex space-x-2"><button class="edit-product-btn text-sm bg-blue-600 p-2 rounded" data-id="${product.id}">Επεξεργασία</button><button class="delete-product-btn text-sm bg-red-600 p-2 rounded" data-id="${product.id}">Διαγραφή</button></div>`;
                    productLibraryList.appendChild(li);
                });
                document.querySelectorAll('.edit-product-btn').forEach(btn => btn.addEventListener('click', handleEditProduct));
                document.querySelectorAll('.delete-product-btn').forEach(btn => btn.addEventListener('click', handleDeleteProduct));
            }
            async function handleEditProduct(event) { const product = productLibrary.find(p => p.id === event.target.dataset.id); if (product) openAddModal(true, product); }
            async function handleDeleteProduct(event) { const productId = event.target.dataset.id; const confirmed = await showCustomAlert('Είστε σίγουροι για τη διαγραφή;', true); if (confirmed) { productLibrary = productLibrary.filter(p => p.id !== productId); saveData(); renderProductLibrary(); } }
            
            function showModalStep(step) {
                const stepsContainer = modal.querySelector('#modal-steps-container');
                stepsContainer.querySelectorAll('.modal-step').forEach(s => s.classList.add('hidden'));
                const currentStep = stepsContainer.querySelector(`#modal-step-${step}`);
                if (currentStep) currentStep.classList.remove('hidden');
                modal.querySelector('#modal-video-container').style.display = (step === 1 || step === 3) ? 'block' : 'none';
            }

            async function openAddModal(isEditing = false, product = null) {
                let editProductId = null;
                let newProductData = {};
                const m = modal;
                m.querySelector('#capture-label-btn').onclick = onCaptureLabel;
                m.querySelector('#confirm-data-btn').onclick = () => { newProductData.caloriesPer100g = parseInt(modal.querySelector('#calories-input').value, 10); newProductData.weight = parseInt(modal.querySelector('#weight-input').value, 10); onConfirmData(newProductData); };
                m.querySelector('#capture-product-btn').onclick = () => onCaptureProduct(newProductData);
                m.querySelector('#save-product-btn').onclick = () => onSaveProduct(isEditing, editProductId, newProductData);
                m.querySelectorAll('.modal-cancel-btn').forEach(btn => btn.onclick = closeModal);
                m.querySelector('#recapture-product-btn').onclick = () => showModalStep(3);
                if (isEditing && product) {
                    editProductId = product.id;
                    m.querySelector('#calories-input').value = product.caloriesPer100g; m.querySelector('#weight-input').value = product.weight; m.querySelector('#product-name-input').value = product.name; m.querySelector('#product-preview-img').src = product.imageBase64; newProductData = { imageBase64: product.imageBase64, keywords: product.keywords }; m.querySelector('#step2-title').textContent = 'Επεξεργασία Δεδομένων'; m.querySelector('#step4-title').textContent = 'Επεξεργασία Ονόματος'; m.querySelector('#save-product-btn').textContent = 'Αποθήκευση Αλλαγών'; m.querySelector('#recapture-product-btn').classList.remove('hidden');
                } else {
                    editProductId = null;
                    ['#calories-input', '#weight-input', '#product-name-input'].forEach(sel => m.querySelector(sel).value = ''); m.querySelector('#product-preview-img').src = ''; newProductData = {}; m.querySelector('#step2-title').textContent = 'Βήμα 2: Επιβεβαίωση Θερμίδων και Βάρους'; m.querySelector('#step4-title').textContent = 'Βήμα 4: Ονομασία'; m.querySelector('#save-product-btn').textContent = 'Αποθήκευση Προϊόντος'; m.querySelector('#recapture-product-btn').classList.add('hidden');
                }
                m.classList.remove('hidden'); m.classList.add('flex');
                modalStream = await startCamera(m.querySelector('#modal-video'));
                showModalStep(isEditing ? 2 : 1);
            }

            function closeModal() { modal.classList.add('hidden'); stopCamera(modalStream); modalStream = null; }

            async function onCaptureLabel() {
                const btn = modal.querySelector('#capture-label-btn');
                btn.textContent = "Ανάλυση..."; btn.disabled = true;
                const context = canvas.getContext('2d');
                const mVideo = modal.querySelector('#modal-video');
                canvas.width = mVideo.videoWidth; canvas.height = mVideo.videoHeight;
                context.drawImage(mVideo, 0, 0, canvas.width, canvas.height);
                const base64ImageData = canvas.toDataURL('image/png').split(',')[1];
                const prompt = `From the image of this nutrition label, extract the number of calories (kcal) per 100g. Respond with only a single number.`;
                try {
                    const aiResponse = await callAI(prompt, base64ImageData, false);
                    const calories = parseInt(aiResponse, 10);
                    if (isNaN(calories)) throw new Error("Could not parse calories.");
                    modal.querySelector('#calories-input').value = calories;
                    showModalStep(2);
                } catch (e) { await showCustomAlert("Δεν ήταν δυνατή η ανάγνωση. Εισάγετε χειροκίνητα."); showModalStep(2); } 
                finally { btn.textContent = "Σάρωση Ετικέτας"; btn.disabled = false; }
            }
            async function onConfirmData(data) {
                if(isNaN(data.caloriesPer100g) || isNaN(data.weight) || data.caloriesPer100g <= 0 || data.weight <= 0) { await showCustomAlert("Εισάγετε έγκυρες τιμές."); return; }
                showModalStep(3);
            }
            async function onCaptureProduct(data) {
                const context = canvas.getContext('2d');
                const mVideo = modal.querySelector('#modal-video');
                canvas.width = mVideo.videoWidth; canvas.height = mVideo.videoHeight;
                context.drawImage(mVideo, 0, 0, canvas.width, canvas.height);
                data.imageBase64 = canvas.toDataURL('image/png');
                modal.querySelector('#product-preview-img').src = data.imageBase64;
                showModalStep(4);
            }
            async function onSaveProduct(isEditing, editProductId, newProductData) {
                const name = modal.querySelector('#product-name-input').value.trim();
                const calories = newProductData.caloriesPer100g;
                const weight = newProductData.weight;
                if (!name || isNaN(calories) || isNaN(weight)) { await showCustomAlert("Συμπληρώστε όλα τα πεδία."); return; }
                const btn = modal.querySelector('#save-product-btn');
                btn.textContent = "Ανάλυση εικόνας..."; btn.disabled = true;
                const keywordsPrompt = `Describe the food item in this image with 3-5 simple keywords in English. Respond with ONLY a valid JSON array of strings. Example: ["protein bar", "chocolate", "nuts"]`;
                try {
                    const keywords = await callAI(keywordsPrompt, newProductData.imageBase64.split(',')[1]);
                    newProductData.keywords = keywords;
                    if (isEditing && editProductId) {
                        const idx = productLibrary.findIndex(p => p.id === editProductId);
                        if (idx !== -1) { productLibrary[idx] = {...productLibrary[idx], name, caloriesPer100g: calories, weight, keywords: newProductData.keywords, imageBase64: newProductData.imageBase64 || productLibrary[idx].imageBase64 }; }
                        await showCustomAlert('Οι αλλαγές αποθηκεύτηκαν!');
                    } else {
                        productLibrary.push({ id: `prod_${Date.now()}`, name, caloriesPer100g: calories, weight, imageBase64: newProductData.imageBase64, keywords: newProductData.keywords });
                        await showCustomAlert(`Το προϊόν "${name}" αποθηκεύτηκε!`);
                    }
                    saveData(); closeModal(); renderProductLibrary();
                } catch(e) { await showCustomAlert('Απέτυχε η δημιουργία οπτικής περιγραφής. Το προϊόν δεν αποθηκεύτηκε.'); } 
                finally { btn.textContent = "Αποθήκευση"; btn.disabled = false; }
            }

            // --- Utility Functions ---
            function showCustomAlert(message, isConfirm = false) {
                return new Promise(resolve => {
                    const dialog = document.getElementById('custom-dialog');
                    document.getElementById('dialog-message').textContent = message;
                    document.getElementById('dialog-ok-btn').onclick = () => { dialog.classList.add('hidden'); resolve(true); };
                    document.getElementById('dialog-cancel-btn').onclick = () => { dialog.classList.add('hidden'); resolve(false); };
                    document.getElementById('dialog-cancel-btn').style.display = isConfirm ? 'inline-block' : 'none';
                    dialog.classList.remove('hidden');
                    dialog.classList.add('flex');
                });
            }

            // --- Initial Load ---
            loadData();
            switchView('today-view');
        });
    </script>
</body>
</html>
